/*
License Validator for Kintone Plugin App Views (API-First)
@Copyright(c) 2025 nohohonki
@license MIT

Created by nohohonki
*/
(function(e){"use strict";async function t(){if(!n||!window.Swal)return new Promise((e,t)=>{if(window.Swal)return n=!0,void e();const i=document.createElement("script");i.src="https://cdn.jsdelivr.net/npm/sweetalert2@11",i.onload=(()=>{n=!0,e()}),i.onerror=(()=>{console.error("Failed to load SweetAlert2"),e()}),document.head.appendChild(i)})}let n=!1;const i={API_BASE_URL:{prod:"https://nohohonki.com/backend/api/"},ENVIRONMENT:"prod",SESSION_CACHE:{ENABLED:!0,DURATION:108e5,KEY_PREFIX:"kintone_license_session_"},API:{TIMEOUT:1e4,RETRY_COUNT:2,RETRY_DELAY:1e3}};class s{constructor(e){this.pluginId=e}getApiBaseUrl(){return i.API_BASE_URL[i.ENVIRONMENT]}getKintoneSubdomain(){const e=location.hostname;return e.split(".")[0]}getSessionCacheKey(e,t){return`${i.SESSION_CACHE.KEY_PREFIX}${this.pluginId}_${e}_${t}`}getSessionCache(e,t){if(!i.SESSION_CACHE.ENABLED)return null;try{const n=this.getSessionCacheKey(e,t),s=sessionStorage.getItem(n);if(!s)return null;const o=JSON.parse(s),r=Date.now();return r-o.timestamp>i.SESSION_CACHE.DURATION?(sessionStorage.removeItem(n),null):o.valid}catch(e){return console.error("Failed to read session cache:",e),null}}setSessionCache(e,t,n){if(i.SESSION_CACHE.ENABLED)try{const i=this.getSessionCacheKey(e,t),s={valid:n,timestamp:Date.now()};sessionStorage.setItem(i,JSON.stringify(s))}catch(e){console.error("Failed to cache validation result:",e)}}async fetchWithTimeout(e,t,n=i.API.TIMEOUT){const s=new AbortController,o=setTimeout(()=>s.abort(),n);try{const n=await fetch(e,{...t,signal:s.signal});return clearTimeout(o),n}catch(e){if(clearTimeout(o),"AbortError"===e.name)throw new Error("Request timeout");throw e}}async verifyLicenseWithAPI(e,t){const n=this.getApiBaseUrl()+"license/verify",s=i.API.RETRY_COUNT;for(let o=0;o<=s;o++)try{const r={"Content-Type":"application/json",Accept:"application/json","X-Requested-With":"XMLHttpRequest","X-Kintone-Plugin":"true","X-Kintone-Domain":location.hostname},a={license_key:e,kintone_subdomain:this.getKintoneSubdomain(),product_slug:t,kintone_domain:location.hostname,referrer:document.referrer||location.href,user_agent:navigator.userAgent,timestamp:(new Date).toISOString(),context:"app_view"},c=await this.fetchWithTimeout(n,{method:"POST",headers:r,body:JSON.stringify(a),mode:"cors",credentials:"omit"});if(!c.ok){if(c.status>=400&&c.status<500)return console.error(`License verification failed with status: ${c.status}`),!1;throw new Error(`HTTP error! status: ${c.status}`)}const l=await c.json();return!0===l.valid}catch(e){if(console.error(`License verification attempt ${o+1} failed:`,e),!(o<s))throw e;await new Promise(e=>setTimeout(e,i.API.RETRY_DELAY))}}async showInvalidLicenseWarning(e="プラグイン"){await t(),window.Swal?await Swal.fire({icon:"error",title:"ライセンス認証エラー",text:`${e}のライセンスが無効です`,confirmButtonText:"OK",allowOutsideClick:!1,allowEscapeKey:!1}):alert(`${e}のライセンスが無効です`)}async validate(e={}){const{productSlug:t,pluginName:n="プラグイン",onValid:i,onInvalid:s}=e;if(!t)return console.error("productSlug is required"),await this.showInvalidLicenseWarning(n),!1;try{const e=kintone.plugin.app.getConfig(this.pluginId);if(!e.license_key)return console.error("No license key found in plugin configuration"),await this.showInvalidLicenseWarning(n),s&&s(),!1;const o=this.getSessionCache(t,e.license_key);if(null!==o)return o?(i&&i(),!0):(await this.showInvalidLicenseWarning(n),s&&s(),!1);const r=await this.verifyLicenseWithAPI(e.license_key,t);return this.setSessionCache(t,e.license_key,r),r?(i&&i(),!0):(await this.showInvalidLicenseWarning(n),s&&s(),!1)}catch(e){return console.error("License validation error:",e),await this.showInvalidLicenseWarning(n),s&&s(),!1}}async validateWithKey(e={}){const{productSlug:t,licenseKey:n,pluginName:i="プラグイン",onValid:s,onInvalid:o}=e;if(!t||!n)return console.error("productSlug and licenseKey are required"),await this.showInvalidLicenseWarning(i),o&&o(),!1;try{const e=this.getSessionCache(t,n);if(null!==e)return e?(s&&s(),!0):(await this.showInvalidLicenseWarning(i),o&&o(),!1);const r=await this.verifyLicenseWithAPI(n,t);return this.setSessionCache(t,n,r),r?(s&&s(),!0):(await this.showInvalidLicenseWarning(i),o&&o(),!1)}catch(e){return console.error("License validation error:",e),await this.showInvalidLicenseWarning(i),o&&o(),!1}}clearSessionCache(e){const t=i.SESSION_CACHE.KEY_PREFIX+this.pluginId;e?Object.keys(sessionStorage).forEach(n=>{n.startsWith(t)&&n.includes(e)&&sessionStorage.removeItem(n)}):Object.keys(sessionStorage).forEach(e=>{e.startsWith(t)&&sessionStorage.removeItem(e)})}}window[e]=window[e]||{},window[e].LicenseValidator=new s(e),window[e].configureLicenseValidator=function(e){Object.assign(i,e)}})(kintone.$PLUGIN_ID);