/*!
Portal Live Editor - Complete Version
@Copyright(c) 2025 nohohonki
@license MIT
*/
(function(){"use strict";window.initPortalCustomizer=function(t){function e(){const t=location.pathname,e=t.match(/\/k\/guest\/(\d+)\//);return e?e[1]:null}async function n(t,e=null){try{const n=e?kintone.api.url(`/k/guest/${e}/v1/app/form/fields`,!0):kintone.api.url("/k/v1/app/form/fields",!0),i=await kintone.api(n,"GET",{app:t}),o=i.properties["ãƒãƒ¼ã‚¿ãƒ«ãƒ¦ãƒ¼ã‚¶ãƒ¼ID"],a=i.properties["ãƒãƒ¼ã‚¿ãƒ«ãƒ‡ãƒ¼ã‚¿"];return o&&a}catch(e){return console.error(`ã‚¢ãƒ—ãƒª${t}ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å–å¾—ã‚¨ãƒ©ãƒ¼:`,e),!1}}function i(t,e=null){const n=window.CURRENT_SPACE_ID;return n?kintone.api.url("/k/guest/"+n+"/v1"+t,!0):kintone.api.url("/k/v1"+t,!0)}async function o(t=null){try{const e=t?kintone.api.url("/k/guest/"+t+"/v1/apps",!0):kintone.api.url("/k/v1/apps",!0),i=await kintone.api(e,"GET",{});for(const e of i.apps){const i=e.spaceId||null;if((t&&i===t||!t&&!i)&&await n(e.appId,i))return e.appId}return null}catch(t){return console.error("è¨­å®šç”¨ã‚¢ãƒ—ãƒªã®æ¤œå‡ºã«å¤±æ•—:",t),null}}async function a(t,e="auto"){try{const n=window.DYNAMIC_CONFIG_APP_ID;let o;o="shared"===e?0:"personal"===e?kintone.getLoginUser().id:"shared"===window.currentEditMode?0:"personal"===window.currentEditMode?kintone.getLoginUser().id:0;const a=JSON.stringify(t),d=`ãƒãƒ¼ã‚¿ãƒ«ãƒ¦ãƒ¼ã‚¶ãƒ¼ID = ${o}`,l=await kintone.api(i("/records"),"GET",{app:n,query:d});if(l.records.length>0){const t=l.records[0];await kintone.api(i("/record"),"PUT",{app:n,id:t.ãƒ¬ã‚³ãƒ¼ãƒ‰ç•ªå·.value,record:{"ãƒãƒ¼ã‚¿ãƒ«ãƒ‡ãƒ¼ã‚¿":{value:a}}})}else await kintone.api(i("/record"),"POST",{app:n,record:{"ãƒãƒ¼ã‚¿ãƒ«ãƒ¦ãƒ¼ã‚¶ãƒ¼ID":{value:o},"ãƒãƒ¼ã‚¿ãƒ«ãƒ‡ãƒ¼ã‚¿":{value:a}}})}catch(t){throw console.error("kintoneã‚¢ãƒ—ãƒªã¸ã®ä¿å­˜ã‚¨ãƒ©ãƒ¼:",t),t}}async function d(t="auto"){try{const e=window.DYNAMIC_CONFIG_APP_ID;let n;n="shared"===t?0:kintone.getLoginUser().id;const o=`ãƒãƒ¼ã‚¿ãƒ«ãƒ¦ãƒ¼ã‚¶ãƒ¼ID = ${n}`,a=await kintone.api(i("/records"),"GET",{app:e,query:o});if(a.records.length>0){const t=a.records[0],e=t["ãƒãƒ¼ã‚¿ãƒ«ãƒ‡ãƒ¼ã‚¿"].value;if(e)return JSON.parse(e)}if(("auto"===t||"personal"===t)&&0!==n){const t="ãƒãƒ¼ã‚¿ãƒ«ãƒ¦ãƒ¼ã‚¶ãƒ¼ID = 0",n=await kintone.api(i("/records"),"GET",{app:e,query:t});if(n.records.length>0){const t=n.records[0],e=t["ãƒãƒ¼ã‚¿ãƒ«ãƒ‡ãƒ¼ã‚¿"].value;if(e)return JSON.parse(e)}}return null}catch(t){return console.log("kintoneã‚¢ãƒ—ãƒªã‹ã‚‰ã®ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿ:",t),null}}function l(){const t=document.getElementById("portal-grid"),e=1980,n=Math.floor(e/40);console.log("Container width:",e,"px"),console.log("Calculated columns:",n),window.generateGridCSS(n);const i=100/n;t.style.setProperty("--grid-column-width",i+"%"),t.style.setProperty("--actual-columns",n);const o=GridStack.init({cellHeight:40,cellWidth:40,margin:0,float:!0,disableDrag:!0,disableResize:!1,minWidth:1,minHeight:2,animate:!0,resizable:{handles:"ne, se, sw, nw"},maxRow:50,column:n});window.grid=o,window.editMode=!1;const a=document.getElementById("portal-grid");a&&a.classList.remove("edit-mode"),o.on("resizestop",function(t,e){const n=e.gridstackNode,i=e.classList.contains("no-header-item");n.w<2&&o.update(e,{w:2});const a=i?1:2;n.h<a&&o.update(e,{h:a})}),r(o)}function r(t){document.getElementById("editToggle").addEventListener("click",async()=>{window.editMode?(await w(t),window.editMode=!1,u()):await c()}),document.getElementById("editCancel").addEventListener("click",async()=>{if(window.editMode){const e=await Swal.fire({title:"ç·¨é›†ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã™ã‹ï¼Ÿ",text:"ç·¨é›†ã‚’ä¿å­˜ã›ãšã«ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã‚’å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ",icon:"warning",showCancelButton:!0,confirmButtonColor:"#d33",cancelButtonColor:"#3085d6",confirmButtonText:"ã¯ã„ã€ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã™ã‚‹",cancelButtonText:"ã„ã„ãˆ"});e.isConfirmed&&(await p(t,window.currentEditMode),window.editMode=!1,u(),Swal.fire({icon:"success",title:"ã‚­ãƒ£ãƒ³ã‚»ãƒ«å®Œäº†",text:"ç·¨é›†ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã€å…ƒã®çŠ¶æ…‹ã«æˆ»ã‚Šã¾ã—ãŸã€‚",timer:1500,timerProgressBar:!0,showConfirmButton:!1}))}}),document.getElementById("addWidget").addEventListener("click",()=>{k(t)}),document.getElementById("resetLayout").addEventListener("click",async()=>{const e=await Swal.fire({title:"ç¾åœ¨ã®ã‚¿ãƒ–ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ",text:"ç¾åœ¨ã®ã‚¿ãƒ–ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆãŒå‰Šé™¤ã•ã‚Œã€å…ƒã«æˆ»ã™ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚",icon:"warning",showCancelButton:!0,confirmButtonColor:"#d33",cancelButtonColor:"#3085d6",confirmButtonText:"ã¯ã„ã€ãƒªã‚»ãƒƒãƒˆã™ã‚‹",cancelButtonText:"ã‚­ãƒ£ãƒ³ã‚»ãƒ«"});if(e.isConfirmed){t.removeAll(!1);const e=window.tabs.find(t=>t.id===window.activeTabId);e&&(e.layouts=[],e.widgets={}),Swal.fire({icon:"success",title:"ãƒªã‚»ãƒƒãƒˆå®Œäº†",text:"ç¾åœ¨ã®ã‚¿ãƒ–ãŒãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã—ãŸã€‚",timer:1500,timerProgressBar:!0,showConfirmButton:!1})}}),document.getElementById("deleteMyPortal").addEventListener("click",async()=>{await P()}),document.getElementById("addTab").addEventListener("click",()=>{v()})}async function c(){const{value:t}=await Swal.fire({title:"ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã‚’é¸æŠ",input:"radio",inputOptions:{shared:"å…±æœ‰ãƒãƒ¼ã‚¿ãƒ«ï¼ˆå…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼å…±é€šï¼‰",personal:"å€‹äººãƒãƒ¼ã‚¿ãƒ«ï¼ˆè‡ªåˆ†å°‚ç”¨ï¼‰"},inputValidator:t=>{if(!t)return"ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã‚’é¸æŠã—ã¦ãã ã•ã„ï¼"},showCancelButton:!0,confirmButtonText:"ç·¨é›†é–‹å§‹",cancelButtonText:"ã‚­ãƒ£ãƒ³ã‚»ãƒ«"});t&&(window.currentEditMode=t,window.editMode=!0,await p(window.grid,t),u(),Swal.fire({icon:"success",title:`${"shared"===t?"å…±æœ‰":"å€‹äºº"}ãƒãƒ¼ã‚¿ãƒ«ç·¨é›†ãƒ¢ãƒ¼ãƒ‰`,text:"ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ãŒé–‹å§‹ã•ã‚Œã¾ã—ãŸã€‚",timer:1500,timerProgressBar:!0,showConfirmButton:!1}))}function s(t){const e=document.getElementById("portal-grid");e&&(t?e.classList.add("show-grid"):e.classList.remove("show-grid"));const n=document.getElementById("portal-grid");n&&(t?n.classList.add("edit-mode"):n.classList.remove("edit-mode"))}function u(){const t=document.getElementById("editToggle"),e=document.getElementById("editCancel"),n=document.getElementById("addWidget"),i=document.getElementById("addTab"),o=document.getElementById("resetLayout"),a=document.getElementById("deleteMyPortal");document.getElementById("portal-grid");if(window.editMode){const d="shared"===window.currentEditMode?"å…±æœ‰ãƒãƒ¼ã‚¿ãƒ«ç·¨é›†ä¸­":"ãƒã‚¤ãƒãƒ¼ã‚¿ãƒ«ç·¨é›†ä¸­";t.textContent=`ç·¨é›†çµ‚äº† (${d})`,t.className="kintoneplugin-button-dialog-ok",e.style.display="inline-block",n.style.display="inline-block",i.style.display="inline-block",o.style.display="inline-block",a.style.display="inline-block",window.grid.enableMove(!0),window.grid.enableResize(!0),s(!0),document.querySelectorAll(".portal-tab").forEach(t=>{const e=t.querySelector(".portal-tab-actions");e&&(e.style.display="flex")})}else t.textContent="ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡æ›¿",t.className="kintoneplugin-button-normal",e.style.display="none",n.style.display="none",i.style.display="none",o.style.display="none",a.style.display="none",window.currentEditMode=null,window.grid.enableMove(!1),window.grid.enableResize(!1),s(!1),document.querySelectorAll(".portal-tab").forEach(t=>{const e=t.querySelector(".portal-tab-actions");e&&(e.style.display="none")})}async function w(t){try{window.activeTabId&&E();const t={tabs:window.tabs||[],activeTabId:window.activeTabId,updated:(new Date).toISOString()};await a(t),Swal.fire({icon:"success",title:"ä¿å­˜å®Œäº†",text:"ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆãŒä¿å­˜ã•ã‚Œã¾ã—ãŸã€‚",timer:1500,timerProgressBar:!0,showConfirmButton:!1})}catch(t){console.error("ä¿å­˜ã‚¨ãƒ©ãƒ¼:",t),Swal.fire({icon:"error",title:"ä¿å­˜ã‚¨ãƒ©ãƒ¼",text:"ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚"})}}async function p(t=window.grid,e="auto"){try{const t=await d(e);if(t&&t.tabs)return window.tabs=t.tabs.map(t=>({id:t.id,name:t.name,backgroundColor:t.backgroundColor||"#555555",textColor:t.textColor||"#ffffff",layouts:t.layouts||[],widgets:t.widgets||{}})),window.tabs.length>0&&(window.activeTabId=window.tabs[0].id),m(),window.activeTabId&&S(window.activeTabId),void console.log("ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’æ­£å¸¸ã«èª­ã¿è¾¼ã¿ã¾ã—ãŸ");g()}catch(t){console.error("ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:",t),g()}}function g(){const t={id:"tab_"+Date.now(),name:"ãƒ¡ã‚¤ãƒ³ã‚¿ãƒ–",backgroundColor:"#555555",textColor:"#ffffff",layouts:[],widgets:{}};window.tabs=[t],window.activeTabId=t.id,m()}function m(){const t=document.getElementById("tabs-list");t.innerHTML="",window.tabs&&window.tabs.length>0&&window.tabs.forEach(e=>{const n=f(e);t.appendChild(n)})}function f(t){const e=document.createElement("div");e.className="portal-tab dynamic-colors",e.setAttribute("data-tab-id",t.id),e.style.setProperty("--tab-bg-color",t.backgroundColor),e.style.setProperty("--tab-text-color",t.textColor),t.id===window.activeTabId&&e.classList.add("active"),e.innerHTML=`\n        <span class="portal-tab-label" title="${t.name}">${t.name}</span>\n        <div class="portal-tab-actions">\n          <input type="color" class="portal-tab-color-btn" value="${t.backgroundColor}" title="èƒŒæ™¯è‰²ã‚’å¤‰æ›´">\n          <input type="color" class="portal-tab-color-btn text-color" value="${t.textColor}" title="æ–‡å­—è‰²ã‚’å¤‰æ›´">\n          <button class="portal-tab-delete" title="ã‚¿ãƒ–ã‚’å‰Šé™¤">âœ•</button>\n        </div>\n      `,e.addEventListener("click",e=>{e.target.matches(".portal-tab-color-btn, .portal-tab-delete")||T(t.id)});const n=e.querySelector(".portal-tab-label");n.addEventListener("dblclick",()=>{window.editMode&&b(t.id)});const i=e.querySelector(".portal-tab-color-btn:first-of-type");i.addEventListener("change",e=>{window.editMode&&h(t.id,"backgroundColor",e.target.value)});const o=e.querySelector(".portal-tab-color-btn:last-of-type");o.addEventListener("change",e=>{window.editMode&&h(t.id,"textColor",e.target.value)});const a=e.querySelector(".portal-tab-delete");a.addEventListener("click",e=>{e.stopPropagation(),window.editMode&&y(t.id)});const d=e.querySelector(".portal-tab-actions");return d&&(d.style.display=window.editMode?"flex":"none"),e}async function b(t){const e=window.tabs.find(e=>e.id===t);if(!e)return;const{value:n}=await Swal.fire({title:"ã‚¿ãƒ–åã‚’ç·¨é›†",input:"text",inputValue:e.name,inputPlaceholder:"ã‚¿ãƒ–åã‚’å…¥åŠ›...",showCancelButton:!0,confirmButtonText:"ä¿å­˜",cancelButtonText:"ã‚­ãƒ£ãƒ³ã‚»ãƒ«",inputValidator:t=>{if(!t||""===t.trim())return"ã‚¿ãƒ–åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼"}});n&&(e.name=n.trim(),m())}function h(t,e,n){const i=window.tabs.find(e=>e.id===t);if(!i)return;i[e]=n;const o=document.querySelector(`.portal-tab[data-tab-id="${t}"]`);o&&("backgroundColor"===e?o.style.setProperty("--tab-bg-color",n):"textColor"===e&&o.style.setProperty("--tab-text-color",n))}async function y(t){if(window.tabs.length<=1)return void Swal.fire({icon:"warning",title:"å‰Šé™¤ã§ãã¾ã›ã‚“",text:"æœ€ä½1ã¤ã®ã‚¿ãƒ–ãŒå¿…è¦ã§ã™ã€‚"});const e=window.tabs.find(e=>e.id===t);if(!e)return;const n=await Swal.fire({title:`ã€Œ${e.name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`,text:"ã“ã®ã‚¿ãƒ–ã¨ãã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã¯å®Œå…¨ã«å‰Šé™¤ã•ã‚Œã€å…ƒã«æˆ»ã™ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚",icon:"warning",showCancelButton:!0,confirmButtonColor:"#d33",cancelButtonColor:"#3085d6",confirmButtonText:"ã¯ã„ã€å‰Šé™¤ã™ã‚‹",cancelButtonText:"ã‚­ãƒ£ãƒ³ã‚»ãƒ«"});n.isConfirmed&&(window.tabs=window.tabs.filter(e=>e.id!==t),window.activeTabId===t&&(window.activeTabId=window.tabs[0].id,S(window.activeTabId)),m(),Swal.fire({icon:"success",title:"å‰Šé™¤å®Œäº†",text:"ã‚¿ãƒ–ãŒå‰Šé™¤ã•ã‚Œã¾ã—ãŸã€‚",timer:1500,timerProgressBar:!0,showConfirmButton:!1}))}async function v(){const{value:t}=await Swal.fire({title:"æ–°ã—ã„ã‚¿ãƒ–ã‚’è¿½åŠ ",input:"text",inputPlaceholder:"ã‚¿ãƒ–åã‚’å…¥åŠ›...",inputValue:`ã‚¿ãƒ–${window.tabs.length+1}`,showCancelButton:!0,confirmButtonText:"è¿½åŠ ",cancelButtonText:"ã‚­ãƒ£ãƒ³ã‚»ãƒ«",inputValidator:t=>{if(!t||""===t.trim())return"ã‚¿ãƒ–åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼"}});if(t){const e={id:"tab_"+Date.now(),name:t.trim(),backgroundColor:"#555555",textColor:"#ffffff",layouts:[],widgets:{}};window.tabs.push(e),m(),T(e.id),Swal.fire({icon:"success",title:"ã‚¿ãƒ–è¿½åŠ å®Œäº†",text:`ã€Œ${e.name}ã€ãŒè¿½åŠ ã•ã‚Œã¾ã—ãŸã€‚`,timer:1500,timerProgressBar:!0,showConfirmButton:!1})}}async function k(t){const{value:e}=await Swal.fire({title:"ã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆã‚’è¿½åŠ ",input:"select",inputOptions:{"app-display":"ã‚¢ãƒ—ãƒªè¡¨ç¤ºï¼ˆãƒ“ãƒ¥ãƒ¼ãƒ»ã‚°ãƒ©ãƒ•ï¼‰","rich-text":"ãƒªãƒƒãƒãƒ†ã‚­ã‚¹ãƒˆ","app-shortcuts":"ã‚¢ãƒ—ãƒªã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ",iframe:"å¤–éƒ¨ã‚µã‚¤ãƒˆ(iframe)"},inputPlaceholder:"ã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆç¨®é¡ã‚’é¸æŠ",showCancelButton:!0,confirmButtonText:"æ¬¡ã¸",cancelButtonText:"ã‚­ãƒ£ãƒ³ã‚»ãƒ«"});if(e){const{value:n}=await Swal.fire({title:"ã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆãƒ˜ãƒƒãƒ€ãƒ¼",input:"radio",inputOptions:{true:"ãƒ˜ãƒƒãƒ€ãƒ¼ã‚ã‚Šï¼ˆã‚¿ã‚¤ãƒˆãƒ«è¡¨ç¤ºï¼‰",false:"ãƒ˜ãƒƒãƒ€ãƒ¼ãªã—ï¼ˆãƒ•ãƒ«ã‚µã‚¤ã‚ºè¡¨ç¤ºï¼‰"},inputValue:"true",showCancelButton:!0,confirmButtonText:"ã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆã‚’è¿½åŠ ",cancelButtonText:"ã‚­ãƒ£ãƒ³ã‚»ãƒ«"});void 0!==n&&x(t,e,"true"===n)}}function x(t,e,n=!0,i=null,o=null){const a="widget_"+Date.now();let d="";switch(e){case"app-display":d=B(a,n,i,o);break;case"rich-text":d=C(a,n,i,o);break;case"app-shortcuts":d=$(a,n,i,o);break;case"iframe":d=I(a,n,i,o);break;default:return void console.error("Unknown widget type:",e)}t.addWidget(d,{x:0,y:0,w:6,h:n?4:3,id:a}),console.log("Widget added:",e,a)}function B(t,e=!0,n=null,i=null){const o=e?"":"no-header",a=n||"ã‚¢ãƒ—ãƒªè¡¨ç¤º",d=i||"#4caf79";return`\n        <div class="portal-widget ${o}" data-widget-type="app-display">\n          <div class="widget-header dynamic-colors" style="--header-color: ${d}; --header-color-dark: ${d}dd;">\n            <div class="widget-title">${a}</div>\n            <button class="widget-edit-header" onclick="editWidgetHeader('${t}')">ãƒ˜ãƒƒãƒ€ãƒ¼ç·¨é›†</button>\n            <button class="widget-edit-btn" onclick="editAppDisplayWidget('${t}')">ç·¨é›†</button>\n            <button class="widget-delete-btn" onclick="deleteWidget('${t}')"><span class="deleteText">âœ•</span></button>\n          </div>\n          <div class="widget-content">\n            <div class="app-display-container">\n              <p class="widget-placeholder-text">\n                ã‚¢ãƒ—ãƒªã‚’é¸æŠã—ã¦ãã ã•ã„<br>\n                <small>ç·¨é›†ãƒœã‚¿ãƒ³ã‹ã‚‰ã‚¢ãƒ—ãƒªã¨ãƒ“ãƒ¥ãƒ¼ã‚’è¨­å®šã§ãã¾ã™</small>\n              </p>\n            </div>\n          </div>\n        </div>\n      `}function C(t,e=!0,n=null,i=null){const o=e?"":"no-header",a=n||"ãƒªãƒƒãƒãƒ†ã‚­ã‚¹ãƒˆ",d=i||"#4caf79";return`\n        <div class="portal-widget ${o}" data-widget-type="rich-text">\n          <div class="widget-header dynamic-colors" style="--header-color: ${d}; --header-color-dark: ${d}dd;">\n            <div class="widget-title">${a}</div>\n            <button class="widget-edit-header" onclick="editWidgetHeader('${t}')">ãƒ˜ãƒƒãƒ€ãƒ¼ç·¨é›†</button>\n            <button class="widget-edit-btn" onclick="toggleRichTextEdit('${t}')">ç·¨é›†</button>\n            <button class="widget-delete-btn" onclick="deleteWidget('${t}')"><span class="deleteText">âœ•</span></button>\n          </div>\n          <div class="widget-content">\n            <div class="richtext-container" id="richtext-${t}">\n              <div class="richtext-content" onclick="startRichTextEdit('${t}')">\n                <p>ã“ã“ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ†ã‚­ã‚¹ãƒˆã‚’ç·¨é›†...</p>\n              </div>\n            </div>\n          </div>\n        </div>\n      `}function $(t,e=!0,n=null,i=null){const o=e?"":"no-header",a=n||"ã‚¢ãƒ—ãƒªã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ",d=i||"#4caf79";return`\n        <div class="portal-widget ${o}" data-widget-type="app-shortcuts">\n          <div class="widget-header dynamic-colors" style="--header-color: ${d}; --header-color-dark: ${d}dd;">\n            <div class="widget-title">${a}</div>\n            <button class="widget-edit-header" onclick="editWidgetHeader('${t}')">ãƒ˜ãƒƒãƒ€ãƒ¼ç·¨é›†</button>\n            <button class="widget-edit-btn" onclick="editAppShortcutsWidget('${t}')">ç·¨é›†</button>\n            <button class="widget-delete-btn" onclick="deleteWidget('${t}')"><span class="deleteText">âœ•</span></button>\n          </div>\n          <div class="widget-content">\n            <div class="app-shortcuts-container" id="shortcuts-${t}">\n              <p class="widget-placeholder-text-small">\n                ã‚¢ãƒ—ãƒªã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆã‚’è¿½åŠ ã—ã¦ãã ã•ã„<br>\n                <small>ç·¨é›†ãƒœã‚¿ãƒ³ã‹ã‚‰è¨­å®šã§ãã¾ã™</small>\n              </p>\n            </div>\n          </div>\n        </div>\n      `}function I(t,e=!0,n=null,i=null){const o=e?"":"no-header",a=n||"å¤–éƒ¨ã‚µã‚¤ãƒˆ",d=i||"#4caf79";return`\n        <div class="portal-widget ${o}" data-widget-type="iframe">\n          <div class="widget-header dynamic-colors" style="--header-color: ${d}; --header-color-dark: ${d}dd;">\n            <div class="widget-title">${a}</div>\n            <button class="widget-edit-header" onclick="editWidgetHeader('${t}')">ãƒ˜ãƒƒãƒ€ãƒ¼ç·¨é›†</button>\n            <button class="widget-edit-btn" onclick="editIframeWidget('${t}')">ç·¨é›†</button>\n            <button class="widget-delete-btn" onclick="deleteWidget('${t}')"><span class="deleteText">âœ•</span></button>\n          </div>\n          <div class="widget-content">\n            <div class="iframe-container">\n              <p class="widget-placeholder-text">\n                URLã‚’è¨­å®šã—ã¦ãã ã•ã„<br>\n                <small>ç·¨é›†ãƒœã‚¿ãƒ³ã‹ã‚‰URLã‚’è¨­å®šã§ãã¾ã™</small>\n              </p>\n            </div>\n          </div>\n        </div>\n      `}function T(t){window.activeTabId&&window.grid&&window.activeTabId!==t&&E(),window.activeTabId=t,document.querySelectorAll(".portal-tab").forEach(t=>{t.classList.remove("active")});const e=document.querySelector(`.portal-tab[data-tab-id="${t}"]`);e&&e.classList.add("active"),S(t)}function E(){const t=window.tabs.find(t=>t.id===window.activeTabId);if(!t)return;const e=window.grid.save();t.layouts=e,console.log("ç¾åœ¨ã®ã‚¿ãƒ–ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’ä¿å­˜ã—ã¾ã—ãŸ:",window.activeTabId)}function S(t){const e=window.tabs.find(e=>e.id===t);e&&window.grid&&(window.grid.removeAll(),e.layouts&&Array.isArray(e.layouts)&&e.layouts.length>0&&window.grid.load(e.layouts))}async function L(){try{const t=e(),n=await o(t);if(!n)return void console.log("è¨­å®šç”¨ã‚¢ãƒ—ãƒªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ãƒãƒ¼ã‚¿ãƒ«ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã¯ç„¡åŠ¹ã§ã™ã€‚");window.DYNAMIC_CONFIG_APP_ID=n,window.CURRENT_SPACE_ID=t,await Promise.all([R("https://cdn.jsdelivr.net/npm/gridstack@10.1.0/dist/gridstack-all.js"),R("https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"),R("https://cdn.jsdelivr.net/npm/sweetalert2@11"),R("https://unpkg.com/quill@1.3.6/dist/quill.js"),R("https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js")]),H("https://cdn.jsdelivr.net/npm/gridstack@10.1.0/dist/gridstack.min.css"),H("https://unpkg.com/quill@1.3.6/dist/quill.snow.css"),H("https://cdn.jsdelivr.net/gh/nohohonki/portal-customization-plugin@main/portal-live-editor.min.css"),setTimeout(()=>{M()},500)}catch(t){console.error("ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ:",t)}}function M(){const t=kintone.getLoginUser(),e=!_.ADMIN_ONLY||t.isAdmin,n=document.querySelector(".kintone-portal-content-space");if(!n)return void console.log("ãƒãƒ¼ã‚¿ãƒ«ç”»é¢ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");const i=document.createElement("div");i.innerHTML=`\n        <div id="portal-customizer">\n          <div id="portal-toolbar">\n            <div id="tabs-container">\n              <div id="tabs-list">\n                <!-- ã‚¿ãƒ–ãŒã“ã“ã«å‹•çš„ã«è¿½åŠ ã•ã‚Œã¾ã™ -->\n              </div>\n              <button id="addTab" class="kintoneplugin-button-normal">\n                + ã‚¿ãƒ–è¿½åŠ \n              </button>\n            </div>\n            <div class="editButtonWrap">\n              <button id="editToggle" class="kintoneplugin-button-normal" style="display: ${e?"inline-block":"none"};">\n                ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡æ›¿\n              </button>\n              <button id="editCancel" class="kintoneplugin-button-dialog-cancel">\n                ã‚­ãƒ£ãƒ³ã‚»ãƒ«\n              </button>\n              <button id="addWidget" class="kintoneplugin-button-normal">\n                ã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆè¿½åŠ \n              </button>\n              <button id="resetLayout" class="kintoneplugin-button-dialog-cancel">\n                ç¾åœ¨ã®ã‚¿ãƒ–ã‚’ãƒªã‚»ãƒƒãƒˆ\n              </button>\n              <button id="deleteMyPortal" class="kintoneplugin-button-dialog-cancel">\n                ãƒã‚¤ãƒãƒ¼ã‚¿ãƒ«ã‚’å‰Šé™¤ã™ã‚‹\n              </button>\n            </div>\n          </div>\n          <div class="grid-stack" id="portal-grid"></div>\n        </div>\n      `,n.insertBefore(i,n.firstChild),l(),p(),console.log("ãƒãƒ¼ã‚¿ãƒ«ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚¶ãƒ¼ãŒåˆæœŸåŒ–ã•ã‚Œã¾ã—ãŸï¼ˆå®Œå…¨ç‰ˆï¼‰")}async function P(){const t="personal"===window.currentEditMode?"personal":"shared",e="personal"===t?"å€‹äººãƒãƒ¼ã‚¿ãƒ«":"å…±æœ‰ãƒãƒ¼ã‚¿ãƒ«",n=await Swal.fire({title:`${e}ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`,text:`${e}ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã¨ã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆãŒå®Œå…¨ã«å‰Šé™¤ã•ã‚Œã€å…ƒã«æˆ»ã™ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚`,icon:"warning",showCancelButton:!0,confirmButtonColor:"#d33",cancelButtonColor:"#3085d6",confirmButtonText:"ã¯ã„ã€å‰Šé™¤ã™ã‚‹",cancelButtonText:"ã‚­ãƒ£ãƒ³ã‚»ãƒ«"});if(n.isConfirmed)try{const n=window.DYNAMIC_CONFIG_APP_ID,o="personal"===t?kintone.getLoginUser().id:0,a=`ãƒãƒ¼ã‚¿ãƒ«ãƒ¦ãƒ¼ã‚¶ãƒ¼ID = ${o}`,d=await kintone.api(i("/records"),"GET",{app:n,query:a});if(d.records.length>0){const t=d.records[0].ãƒ¬ã‚³ãƒ¼ãƒ‰ç•ªå·.value;await kintone.api(i("/record"),"DELETE",{app:n,id:t})}window.grid.removeAll(!1),g(),window.editMode=!1,u(),Swal.fire({icon:"success",title:"å‰Šé™¤å®Œäº†",text:`${e}ãŒå‰Šé™¤ã•ã‚Œã¾ã—ãŸã€‚`,timer:2e3,timerProgressBar:!0,showConfirmButton:!1})}catch(t){console.error("å‰Šé™¤ã‚¨ãƒ©ãƒ¼:",t),Swal.fire({icon:"error",title:"å‰Šé™¤ã‚¨ãƒ©ãƒ¼",text:`${e}ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸã€‚`})}}async function q(t){const e=document.querySelector(`[gs-id="${t}"]`);if(!e)return;const n=e.querySelector(".portal-widget"),i=n.querySelector(".widget-title"),o=n.querySelector(".widget-header"),a=i.textContent,d=o.style.getPropertyValue("--header-color")||"#4caf79",{value:l}=await Swal.fire({title:"ãƒ˜ãƒƒãƒ€ãƒ¼ç·¨é›†",html:`\n          <div class="swal2-form-group">\n            <label for="edit-widget-title" class="swal2-form-label">ã‚¿ã‚¤ãƒˆãƒ«:</label>\n            <input type="text" id="edit-widget-title" class="swal2-input swal2-form-input" value="${a}">\n          </div>\n          <div class="swal2-form-group">\n            <label for="edit-widget-color" class="swal2-form-label">ãƒ˜ãƒƒãƒ€ãƒ¼è‰²:</label>\n            <input type="color" id="edit-widget-color" class="swal2-color-input" value="${d}">\n          </div>\n        `,showCancelButton:!0,confirmButtonText:"ä¿å­˜",cancelButtonText:"ã‚­ãƒ£ãƒ³ã‚»ãƒ«",preConfirm:()=>{const t=document.getElementById("edit-widget-title").value,e=document.getElementById("edit-widget-color").value;return t.trim()?{title:t.trim(),color:e}:(Swal.showValidationMessage("ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"),!1)}});l&&(i.textContent=l.title,o.style.setProperty("--header-color",l.color),o.style.setProperty("--header-color-dark",l.color+"dd"),o.classList.add("dynamic-colors"))}async function A(){try{const t=window.CURRENT_SPACE_ID,e=t?kintone.api.url(`/k/guest/${t}/v1/apps`,!0):kintone.api.url("/k/v1/apps",!0),n=await kintone.api(e,"GET",{});return n.apps.map(t=>({appId:t.appId,name:t.name,spaceId:t.spaceId,spaceName:t.spaceName}))}catch(t){return console.error("ã‚¢ãƒ—ãƒªä¸€è¦§å–å¾—ã‚¨ãƒ©ãƒ¼:",t),[]}}async function D(t,e){Swal.fire({icon:"info",title:"ã‚¢ãƒ—ãƒªè¡¨ç¤ºè¨­å®š",text:"ã‚¢ãƒ—ãƒªãŒé¸æŠã•ã‚Œã¾ã—ãŸã€‚ãƒ“ãƒ¥ãƒ¼/ã‚°ãƒ©ãƒ•é¸æŠæ©Ÿèƒ½ã¯ä»Šå¾Œå®Ÿè£…äºˆå®šã§ã™ã€‚",timer:2e3,timerProgressBar:!0,showConfirmButton:!1})}function W(t){const e=document.getElementById(`richtext-${t}`);if(!e||e.classList.contains("editing"))return;const n=e.querySelector(".richtext-content"),i=n.innerHTML;e.classList.add("editing"),e.innerHTML=`<div id="quill-editor-${t}"></div>`;const o=new Quill(`#quill-editor-${t}`,{theme:"snow",modules:{toolbar:[[{header:[1,2,3,!1]}],["bold","italic","underline","strike"],[{color:[]},{background:[]}],[{align:[]}],[{list:"ordered"},{list:"bullet"}],["blockquote","code-block"],["link","image"],["clean"]]}});o.root.innerHTML=i,window.activeQuillEditor={editor:o,widgetId:t}}function N(t){const e=document.getElementById(`richtext-${t}`);if(!e||!e.classList.contains("editing"))return;const n=window&&window.activeQuillEditor&&window.activeQuillEditor.editor&&window.activeQuillEditor.editor.root&&window.activeQuillEditor.editor.root.innerHTML||"";e.classList.remove("editing"),e.innerHTML=`\n        <div class="richtext-content" onclick="startRichTextEdit('${t}')">\n          ${n||"<p>ã“ã“ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ†ã‚­ã‚¹ãƒˆã‚’ç·¨é›†...</p>"}\n        </div>\n      `,window.activeQuillEditor=null}const _=t||{ADMIN_ONLY:!1},R=t=>new Promise((e,n)=>{const i=document.createElement("script");i.src=t,i.onload=e,i.onerror=n,document.head.appendChild(i)}),H=t=>{const e=document.createElement("link");e.rel="stylesheet",e.href=t,document.head.appendChild(e)};window.generateGridCSS=function(t){const e=100/t,n=`\n        .grid-stack.gs-${t} > .grid-stack-item {\n          width: ${e}%;\n        }\n        `+Array.from({length:t-1},(n,i)=>{const o=i+1;return`\n          .grid-stack.gs-${t} > .grid-stack-item[gs-x='${o}'] { left: ${e*o}%; }\n          .grid-stack.gs-${t} > .grid-stack-item[gs-w='${o+1}'] { width: ${e*(o+1)}%; }\n          `}).join(""),i=document.createElement("style");i.textContent=n,document.head.appendChild(i)},window.deleteWidget=function(t){window.editMode&&Swal.fire({title:"ã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ",text:"ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚",icon:"warning",showCancelButton:!0,confirmButtonColor:"#d33",cancelButtonColor:"#3085d6",confirmButtonText:"å‰Šé™¤",cancelButtonText:"ã‚­ãƒ£ãƒ³ã‚»ãƒ«"}).then(e=>{if(e.isConfirmed){const e=document.querySelector(`[gs-id="${t}"]`);e&&window.grid.removeWidget(e),Swal.fire({title:"å‰Šé™¤å®Œäº†",text:"ã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆãŒå‰Šé™¤ã•ã‚Œã¾ã—ãŸã€‚",icon:"success",timer:1500,showConfirmButton:!1})}})},window.editWidgetHeader=function(t){window.editMode&&q(t)},window.editAppDisplayWidget=async function(t){if(!window.editMode)return;const e=await A(),n={};e.forEach(t=>{const e=t.spaceId?` [ã‚¹ãƒšãƒ¼ã‚¹: ${t.spaceName||t.spaceId}]`:"";n[t.appId]=`${t.name}${e}`});const{value:i}=await Swal.fire({title:"ã‚¢ãƒ—ãƒªã‚’é¸æŠ",input:"select",inputOptions:n,inputPlaceholder:"ã‚¢ãƒ—ãƒªã‚’é¸æŠã—ã¦ãã ã•ã„",showCancelButton:!0,confirmButtonText:"æ¬¡ã¸",cancelButtonText:"ã‚­ãƒ£ãƒ³ã‚»ãƒ«"});i&&await D(t,i)},window.toggleRichTextEdit=function(t){if(!window.editMode)return;const e=document.getElementById(`richtext-${t}`);e&&(e.classList.contains("editing")?N(t):W(t))},window.editAppShortcutsWidget=async function(t){if(!window.editMode)return;const e=await A(),n=[];let i=!0;for(;i&&n.length<20;){const t=e.filter(t=>!n.find(e=>e.appId===t.appId));if(0===t.length)break;const o={};t.forEach(t=>{const e=t.spaceId?` [ã‚¹ãƒšãƒ¼ã‚¹: ${t.spaceName||t.spaceId}]`:"";o[t.appId]=`${t.name}${e}`});const{value:a}=await Swal.fire({title:`ã‚¢ãƒ—ãƒªã‚’é¸æŠ (${n.length}/20)`,input:"select",inputOptions:o,inputPlaceholder:"ã‚¢ãƒ—ãƒªã‚’é¸æŠã—ã¦ãã ã•ã„",showCancelButton:!0,confirmButtonText:"è¿½åŠ ",cancelButtonText:n.length>0?"å®Œäº†":"ã‚­ãƒ£ãƒ³ã‚»ãƒ«"});if(a){const t=e.find(t=>t.appId===a);if(n.push(t),n.length>=20)i=!1;else{const{value:t}=await Swal.fire({title:"ã‚¢ãƒ—ãƒªã‚’è¿½åŠ ã—ã¾ã™ã‹ï¼Ÿ",text:`ç¾åœ¨${n.length}å€‹ã®ã‚¢ãƒ—ãƒªãŒé¸æŠã•ã‚Œã¦ã„ã¾ã™ã€‚`,icon:"question",showCancelButton:!0,confirmButtonText:"ã•ã‚‰ã«è¿½åŠ ",cancelButtonText:"å®Œäº†"});i=t}}else i=!1}if(n.length>0){const e=document.getElementById(`shortcuts-${t}`);e.innerHTML=n.map(t=>{const e=t.spaceId?`/k/guest/${t.spaceId}`:"/k",n=`${e}/#/app/${t.appId}`;return`\n            <a href="${n}" class="app-shortcut-btn" target="_blank">\n              <span>ğŸ“±</span>\n              <span>${t.name}</span>\n            </a>\n          `}).join("")}},window.editIframeWidget=async function(t){if(!window.editMode)return;const{value:e}=await Swal.fire({title:"iFrame URLã‚’è¨­å®š",input:"url",inputPlaceholder:"https://example.com",showCancelButton:!0,confirmButtonText:"è¨­å®š",cancelButtonText:"ã‚­ãƒ£ãƒ³ã‚»ãƒ«",inputValidator:t=>t?t.startsWith("http://")||t.startsWith("https://")?void 0:"æœ‰åŠ¹ãªURLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆhttp://ã¾ãŸã¯https://ã§å§‹ã¾ã‚‹ï¼‰":"URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼"});if(e){const n=document.querySelector(`[gs-id="${t}"]`),i=n.querySelector(".iframe-container");i.innerHTML=`<iframe src="${e}" class="iframe-widget-frame"></iframe>`}},L()},"function"==typeof window.initPortalCustomizer||"undefined"!=typeof kintone&&kintone.events.on(["portal.show","space.portal.show"],async()=>{window.initPortalCustomizer()})})();