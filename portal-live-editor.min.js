/*!
Portal Live Editor - Complete Version
@Copyright(c) 2025 nohohonki
@license MIT
*/
(function(){"use strict";window.initPortalCustomizer=async function(t){function e(){const t=location.pathname,e=t.match(/\/k\/guest\/(\d+)\//);if(e)return e[1];const n=location.hash,i=n.match(/#\/space\/(\d+)/);return i?i[1]:null}function n(){const t=location.pathname;return null!==t.match(/\/k\/guest\/(\d+)\//)}function i(){const t=location.pathname,e=t.match(/\/k\/guest\/(\d+)\//);if(e)return`guest_${e[1]}`;const n=location.hash,i=n.match(/#\/space\/(\d+)/);return i?`space_${i[1]}`:"main"}function o(){const t=kintone.api.url("/k/v1/app",!0),e=t.match(/guest\/(\d+)\//);if(e){const t=e[1];return{isGuestSpace:!0,spaceId:t}}return{isGuestSpace:!1,spaceId:null}}function a(t,i=null){if(i===window.DYNAMIC_CONFIG_APP_ID){if(n()){const n=e();return`/k/guest/${n}/v1${t}`}return kintone.api.url("/k/v1"+t,!0)}const o=window.CURRENT_SPACE_ID;return o?`/k/guest/${o}/v1${t}`:kintone.api.url("/k/v1"+t,!0)}async function d(t=null){try{let e;e=t?await kintone.api(`/k/guest/${t}/v1/apps`,"GET",{}):await kintone.api(kintone.api.url("/k/v1/apps",!0),"GET",{});for(const n of e.apps){const e=n.spaceId||null;if((t&&e===t||!t&&!e)&&n.name&&n.name.includes("ポータルカスタマイズ"))return n.appId}return null}catch(t){return console.error("設定用アプリの検出に失敗:",t),null}}async function r(t,e="auto"){try{const o=window.DYNAMIC_CONFIG_APP_ID;let d;d="shared"===e?0:"my"===e?kintone.getLoginUser().id:"shared"===window.currentEditMode?0:"my"===window.currentEditMode?kintone.getLoginUser().id:0;const r=JSON.stringify(t);if(n()){const t=`ユーザーID = ${d}`,e=await kintone.api(a("/records",o),"GET",{app:o,query:t});if(e.records.length>0){const t=e.records[0];await kintone.api(a("/record",o),"PUT",{app:o,id:t.レコード番号.value,record:{"データ":{value:r}}})}else await kintone.api(a("/record",o),"POST",{app:o,record:{"ユーザーID":{value:d},"データ":{value:r}}})}else{const t=i(),e=`ユーザーID = ${d} and 判定 = "${t}"`,n=await kintone.api(a("/records",o),"GET",{app:o,query:e});if(n.records.length>0){const e=n.records[0];await kintone.api(a("/record",o),"PUT",{app:o,id:e.レコード番号.value,record:{"データ":{value:r},"判定":{value:t}}})}else await kintone.api(a("/record",o),"POST",{app:o,record:{"ユーザーID":{value:d},"データ":{value:r},"判定":{value:t}}})}}catch(t){throw console.error("kintoneアプリへの保存エラー:",t),t}}async function s(t="auto"){try{const e=window.DYNAMIC_CONFIG_APP_ID;let o;if(o="shared"===t?0:kintone.getLoginUser().id,n()){const n=`ユーザーID = ${o}`,i=await kintone.api(a("/records",e),"GET",{app:e,query:n});if(i.records.length>0){const t=i.records[0],e=t["データ"].value;if(e)return 0!==o&&(window.hasMyPortal=!0,window.currentViewMode="personal"),JSON.parse(e)}if(("auto"===t||"my"===t)&&0!==o){window.hasMyPortal=!1,window.currentViewMode="shared";try{const t=await H(window.DYNAMIC_CONFIG_APP_ID);if(t.canAccessShared){const t="ユーザーID = 0",n=await kintone.api(a("/records",e),"GET",{app:e,query:t});if(n.records.length>0){const t=n.records[0],e=t["データ"].value;if(e)return JSON.parse(e)}}return null}catch(t){console.warn("権限チェックエラー、デフォルトで共有ポータルを表示:",t);const n="ユーザーID = 0",i=await kintone.api(a("/records",e),"GET",{app:e,query:n});if(i.records.length>0){const t=i.records[0],e=t["データ"].value;if(e)return JSON.parse(e)}}}}else{const n=i(),d=`ユーザーID = ${o} and 判定 = "${n}"`,r=await kintone.api(a("/records",e),"GET",{app:e,query:d});if(r.records.length>0){const t=r.records[0],e=t["データ"].value;if(e)return 0!==o&&(window.hasMyPortal=!0,window.currentViewMode="personal"),JSON.parse(e)}if(("auto"===t||"my"===t)&&0!==o){window.hasMyPortal=!1,window.currentViewMode="shared";try{const t=await H(window.DYNAMIC_CONFIG_APP_ID);if(t.canAccessShared){const t=`ユーザーID = 0 and 判定 = "${n}"`,i=await kintone.api(a("/records",e),"GET",{app:e,query:t});if(i.records.length>0){const t=i.records[0],e=t["データ"].value;if(e)return JSON.parse(e)}}return null}catch(t){console.warn("権限チェックエラー、デフォルトで共有ポータルを表示:",t);const i=`ユーザーID = 0 and 判定 = "${n}"`,o=await kintone.api(a("/records",e),"GET",{app:e,query:i});if(o.records.length>0){const t=o.records[0],e=t["データ"].value;if(e)return JSON.parse(e)}}}}return null}catch(t){return console.log("kintoneアプリからのデータ読み込みでエラーが発生:",t),null}}function l(){const t=document.getElementById("portal-grid"),e=1980,n=Math.floor(e/40);window.generateGridCSS(n);const i=100/n;t.style.setProperty("--grid-column-width",i+"%"),t.style.setProperty("--actual-columns",n);const o=GridStack.init({cellHeight:40,cellWidth:40,margin:0,float:!0,disableDrag:!0,disableResize:!1,minWidth:1,minHeight:2,animate:!0,resizable:{handles:"ne, se, sw, nw"},maxRow:50,column:n});window.grid=o,window.editMode=!1,window.hasMyPortal=!1,window.currentViewMode="shared";const a=document.getElementById("portal-grid");a&&a.classList.remove("edit-mode"),o.on("resizestop",function(t,e){const n=e.gridstackNode,i=e.classList.contains("no-header-item");n.w<2&&o.update(e,{w:2});const a=i?1:2;n.h<a&&o.update(e,{h:a})}),c(o)}function c(t){document.getElementById("editToggle").addEventListener("click",async()=>{window.editMode?(await f(t),window.editMode=!1,m()):await u()}),document.getElementById("editCancel").addEventListener("click",async()=>{if(window.editMode){const e=await Swal.fire({title:"編集をキャンセルしますか？",text:"編集を保存せずにキャンセルを実行しますか？",icon:"warning",showCancelButton:!0,confirmButtonText:"はい",cancelButtonText:"いいえ"});e.isConfirmed&&(await h(t,window.currentEditMode),window.editMode=!1,m())}}),document.getElementById("addWidget").addEventListener("click",()=>{C(t)}),document.getElementById("resetLayout").addEventListener("click",async()=>{const e=await Swal.fire({title:"現在のタブをリセットしますか？",text:"現在のタブのレイアウトが削除され、元に戻すことはできなくなります。",icon:"warning",showCancelButton:!0,confirmButtonText:"はい",cancelButtonText:"いいえ"});if(e.isConfirmed){const e=window.tabs.find(t=>t.id===window.activeTabId);e&&e.widgets&&Object.keys(e.widgets).forEach(t=>{const e=document.querySelector(`[gs-id="${t}"]`);e&&e.remove()}),t.removeAll(!1),e&&(e.layouts=[],e.widgets={}),v(),Swal.fire({icon:"success",title:"リセット完了",text:"現在のタブがリセットされました。",timer:1500,timerProgressBar:!0,showConfirmButton:!1})}}),document.getElementById("deleteMyPortal").addEventListener("click",async()=>{await U()}),document.getElementById("portalToggle").addEventListener("click",async()=>{await g()}),document.getElementById("addTab").addEventListener("click",()=>{S()})}async function u(){const t=await H(window.DYNAMIC_CONFIG_APP_ID),e=t.canAccessMy,n=t.canAccessShared&&t.canEditShared;if(!e&&!n)return void await Swal.fire({icon:"warning",title:"編集権限がありません",text:"ポータルの編集権限がありません。"});if(e&&!n)return window.currentEditMode="my",void await p("my");if(!e&&n)return window.currentEditMode="shared",void await p("shared");const i=await Swal.fire({title:"編集モードを選択",text:"どちらのポータルを編集しますか？",showCancelButton:e,confirmButtonText:n?"共有ポータル":null,cancelButtonText:e?"マイポータル":null,reverseButtons:!0,allowOutsideClick:!1,allowEscapeKey:!1});i.isConfirmed&&n?(window.currentEditMode="shared",await p("shared")):i.isDismissed&&i.dismiss===Swal.DismissReason.cancel&&e&&(window.currentEditMode="my",await p("my"))}async function p(t){await h(window.grid,t),window.editMode=!0,await m()}function w(t){const e=document.getElementById("portal-grid");e&&(t?e.classList.add("show-grid"):e.classList.remove("show-grid"));const n=document.getElementById("portal-grid");n&&(t?n.classList.add("edit-mode"):n.classList.remove("edit-mode"))}async function g(){if(window.editMode)return;const t="shared"===window.currentViewMode?"personal":"shared";try{await h(window.grid,t),window.currentViewMode=t,await y();const e="personal"===t?"マイポータルに切替":"共有ポータルに切替";Swal.fire({icon:"success",title:`${e}えました`,timer:1500,showConfirmButton:!1})}catch(t){console.error("ポータル切り替えエラー:",t),Swal.fire({icon:"error",title:"切り替えエラー",text:"ポータルの切り替えに失敗しました"})}}async function y(){const t=document.getElementById("portalToggle");if(t)try{const e=await H(window.DYNAMIC_CONFIG_APP_ID);if(window.editMode)return void(t.style.display="none");const n=window.hasMyPortal&&e.canAccessMy&&e.canAccessShared;n?(t.style.display="inline-block",t.textContent="shared"===window.currentViewMode?"マイポータルに切替":"共有ポータルに切替"):t.style.display="none"}catch(e){console.error("ポータル切り替えボタン更新エラー:",e),t.style.display="none"}}async function m(){const t=document.getElementById("editToggle"),e=document.getElementById("editCancel"),n=document.getElementById("addWidget"),i=document.getElementById("addTab"),o=document.getElementById("resetLayout"),a=document.getElementById("deleteMyPortal");if(window.editMode){const d="shared"===window.currentEditMode?"共有ポータル編集中":"マイポータル編集中";t.textContent=`編集終了 (${d})`,t.className="kintoneplugin-button-dialog-ok",e.style.display="inline-block",n.style.display="inline-block",i.style.display="inline-block",o.style.display="inline-block",a.style.display="inline-block",window.grid.enableMove(!0),window.grid.enableResize(!0),w(!0),document.querySelectorAll(".portal-tab").forEach(t=>{const e=t.querySelector(".portal-tab-actions");e&&(e.style.display="flex")}),await y()}else t.textContent="編集する",t.className="kintoneplugin-button-normal",e.style.display="none",n.style.display="none",i.style.display="none",o.style.display="none",a.style.display="none",window.currentEditMode=null,window.grid.enableMove(!1),window.grid.enableResize(!1),await y(),w(!1),document.querySelectorAll(".portal-tab").forEach(t=>{const e=t.querySelector(".portal-tab-actions");e&&(e.style.display="none")})}async function f(t){try{window.activeTabId&&D();const t={};if(document.querySelectorAll(".portal-widget").forEach(e=>{const n=e.getAttribute("data-id"),i=e.getAttribute("data-type");if(n&&i)switch(t[n]={type:i,title:e.querySelector(".widget-title")?e.querySelector(".widget-title").textContent:"",customTitle:e.getAttribute("data-custom-title"),customColor:e.getAttribute("data-custom-color"),hasHeader:e.getAttribute("data-has-header"),fontSize:e.getAttribute("data-font-size"),textAlign:e.getAttribute("data-text-align"),textColor:e.getAttribute("data-text-color")},i){case"app-display":t[n].appId=e.getAttribute("data-app-id"),t[n].viewId=e.getAttribute("data-view-id"),t[n].spaceId=e.getAttribute("data-space-id"),t[n].isGuestSpace=e.getAttribute("data-is-guest-space"),t[n].threadId=e.getAttribute("data-thread-id");break;case"app-shortcuts":const o=e.getAttribute("data-shortcuts");o&&(t[n].shortcuts=JSON.parse(o));break;case"rich-text":const a=e.querySelector("#richtext_"+n);a&&(t[n].content=a.innerHTML);break;case"iframe":const d=e.querySelector("iframe");d&&(t[n].url=d.src)}}),window.activeTabId){const e=window.tabs.find(t=>t.id===window.activeTabId);e&&(e.widgets=t)}const e={tabs:window.tabs||[],activeTabId:window.activeTabId,updated:(new Date).toISOString()};await r(e),Swal.fire({icon:"success",title:"保存完了",text:"レイアウトが保存されました。",timer:1500,timerProgressBar:!0,showConfirmButton:!1})}catch(t){console.error("保存エラー:",t),Swal.fire({icon:"error",title:"保存エラー",text:"レイアウトの保存に失敗しました。"})}}async function h(t=window.grid,e="auto"){try{const t=await s(e);if(t&&t.tabs)return window.tabs=t.tabs.map(t=>({id:t.id,name:t.name,backgroundColor:t.backgroundColor||"#555555",textColor:t.textColor||"#ffffff",layouts:t.layouts||[],widgets:t.widgets||t.widgetData||{}})),window.tabs.length>0&&(window.activeTabId=window.tabs[0].id),v(),void(window.activeTabId&&N(window.activeTabId));b()}catch(t){console.error("レイアウト読み込みエラー:",t),b()}}function b(){const t={id:"tab_"+Date.now(),name:"メインタブ",backgroundColor:"#555555",textColor:"#ffffff",layouts:[],widgets:{}};window.tabs=[t],window.activeTabId=t.id,v()}function v(){const t=document.getElementById("tabs-list");t.innerHTML="",window.tabs&&window.tabs.length>0&&window.tabs.forEach(e=>{const n=x(e);t.appendChild(n)})}function x(t){const e=document.createElement("div");e.className="portal-tab dynamic-colors",e.setAttribute("data-tab-id",t.id),e.style.setProperty("--tab-bg-color",t.backgroundColor),e.style.setProperty("--tab-text-color",t.textColor),t.id===window.activeTabId&&e.classList.add("active"),e.innerHTML=`\n        <span class="portal-tab-label" title="${t.name}">${t.name}</span>\n        <div class="portal-tab-actions">\n          <input type="color" class="portal-tab-color-btn" value="${t.backgroundColor}" title="背景色を変更">\n          <input type="color" class="portal-tab-color-btn text-color" value="${t.textColor}" title="文字色を変更">\n          <button class="portal-tab-delete" title="タブを削除">✕</button>\n        </div>\n      `,e.addEventListener("click",e=>{e.target.matches(".portal-tab-color-btn, .portal-tab-delete")||G(t.id)});const n=e.querySelector(".portal-tab-label");n.addEventListener("dblclick",()=>{window.editMode&&I(t.id)});const i=e.querySelector(".portal-tab-color-btn:first-of-type");i.addEventListener("change",e=>{window.editMode&&k(t.id,"backgroundColor",e.target.value)});const o=e.querySelector(".portal-tab-color-btn:last-of-type");o.addEventListener("change",e=>{window.editMode&&k(t.id,"textColor",e.target.value)});const a=e.querySelector(".portal-tab-delete");a.addEventListener("click",e=>{e.stopPropagation(),window.editMode&&$(t.id)});const d=e.querySelector(".portal-tab-actions");return d&&(d.style.display=window.editMode?"flex":"none"),e}async function I(t){const e=window.tabs.find(e=>e.id===t);if(!e)return;const{value:n}=await Swal.fire({title:"タブ名を編集",input:"text",inputValue:e.name,inputPlaceholder:"タブ名を入力...",showCancelButton:!0,confirmButtonText:"保存",cancelButtonText:"キャンセル",inputValidator:t=>{if(!t||""===t.trim())return"タブ名を入力してください！"}});n&&(e.name=n.trim(),v())}function k(t,e,n){const i=window.tabs.find(e=>e.id===t);if(!i)return;i[e]=n;const o=document.querySelector(`.portal-tab[data-tab-id="${t}"]`);o&&("backgroundColor"===e?o.style.setProperty("--tab-bg-color",n):"textColor"===e&&o.style.setProperty("--tab-text-color",n))}async function $(t){if(window.tabs.length<=1)return void Swal.fire({icon:"warning",title:"削除できません",text:"最低1つのタブが必要です。"});const e=window.tabs.find(e=>e.id===t);if(!e)return;const n=await Swal.fire({title:`「${e.name}」を削除しますか？`,text:"このタブとタブ内のコンテンツは完全に削除され、元に戻すことはできなくなります。",icon:"warning",showCancelButton:!0,confirmButtonText:"はい",cancelButtonText:"いいえ"});n.isConfirmed&&(window.tabs=window.tabs.filter(e=>e.id!==t),window.activeTabId===t&&(window.activeTabId=window.tabs[0].id,N(window.activeTabId)),v())}async function S(){const{value:t}=await Swal.fire({title:"新しいタブを追加",input:"text",inputPlaceholder:"タブ名を入力...",inputValue:`タブ${window.tabs.length+1}`,showCancelButton:!0,confirmButtonText:"追加",cancelButtonText:"キャンセル",inputValidator:t=>{if(!t||""===t.trim())return"タブ名を入力してください！"}});if(t){const e={id:"tab_"+Date.now(),name:t.trim(),backgroundColor:"#555555",textColor:"#ffffff",layouts:[],widgets:{}};window.tabs.push(e),v(),G(e.id)}}async function C(t){const{value:e}=await Swal.fire({title:"ウィジェットを追加",input:"select",inputOptions:{"app-shortcuts":"アプリショートカット","app-display":"アプリ表示（ビュー・グラフ）","rich-text":"リッチテキスト",iframe:"外部サイト埋め込み"},inputPlaceholder:"ウィジェット種類を選択",showCancelButton:!0,confirmButtonText:"次へ",cancelButtonText:"キャンセル"});if(e){const{value:n}=await Swal.fire({title:"ヘッダーの表示",input:"select",inputOptions:{true:"ヘッダーあり（タイトル表示）",false:"ヘッダーなし（コンテンツのみ）"},inputValue:"true",showCancelButton:!0,confirmButtonText:"次へ",cancelButtonText:"キャンセル"});if(void 0!==n){let i=null,o=null,a="standard",d="left",r="white";if("true"===n){const{value:t}=await Swal.fire({title:"ヘッダー設定",html:`\n                <div id="headerEditSwal">\n                  <div style="text-align: left; margin-bottom: 15px;">\n                    <label for="widget-title" style="display: block; margin-bottom: 5px; font-weight: bold;">タイトル:</label>\n                    <input id="widget-title" type="text" class="swal2-input" placeholder="ウィジェットのタイトルを入力" style="margin: 0;">\n                  </div>\n\n                  ${A()}\n\n                  ${Z("#4caf79")}\n                </div>\n              `,showCancelButton:!0,confirmButtonText:"追加",cancelButtonText:"キャンセル",didOpen:()=>{const t=document.getElementById("copy-hex");t&&(t.onclick=(()=>{const e=document.getElementById("hex-code").textContent;window.copyToClipboard(e,t)})),window.updateColorPreview()},preConfirm:()=>{const t=document.getElementById("widget-title").value,e=document.getElementById("widget-color").value,n=T();return Q(e),{title:t.trim(),color:e,...n}}});if(!t)return;i=t.title,o=t.color,a=t.fontSize,d=t.textAlign,r=t.textColor}E(t,e,"true"===n,i,o,a,d,r)}}}function E(t,e,n=!0,i=null,o=null,a="standard",d="left",r="white"){const s="widget_"+Date.now();let l="";switch(e){case"app-display":l=q(s,n,i,o,a,d,r);break;case"rich-text":l=P(s,n,i,o,a,d,r);break;case"app-shortcuts":l=_(s,n,i,o,a,d,r);break;case"iframe":l=L(s,n,i,o,a,d,r);break;default:return void console.error("Unknown widget type:",e)}const c=t.getGridItems();let u=0;c.forEach(t=>{const e=t.gridstackNode;if(e&&void 0!==e.y&&void 0!==e.h){const t=e.y+e.h;t>u&&(u=t)}});const p=Math.floor(.4*t.getColumn());t.addWidget({x:0,y:u,w:p,h:n?6:5,content:l,id:s})}function A(t="standard",e="left",n="white",i="widget"){return`\n        <div style="text-align: left; margin-bottom: 15px;">\n          <label for="${i}-font-size" style="display: block; margin-bottom: 5px; font-weight: bold;">文字サイズ:</label>\n          <select id="${i}-font-size" class="swal2-select" style="margin: 0;">\n            <option value="standard" ${"standard"===t?"selected":""}>標準</option>\n            <option value="large" ${"large"===t?"selected":""}>大</option>\n            <option value="extra-large" ${"extra-large"===t?"selected":""}>特大</option>\n          </select>\n        </div>\n\n        <div style="text-align: left; margin-bottom: 15px;">\n          <label for="${i}-text-align" style="display: block; margin-bottom: 5px; font-weight: bold;">文字並び:</label>\n          <select id="${i}-text-align" class="swal2-select" style="margin: 0;">\n            <option value="left" ${"left"===e?"selected":""}>左</option>\n            <option value="center" ${"center"===e?"selected":""}>真ん中</option>\n            <option value="right" ${"right"===e?"selected":""}>右</option>\n          </select>\n        </div>\n\n        <div style="text-align: left; margin-bottom: 15px;">\n          <label for="${i}-text-color" style="display: block; margin-bottom: 5px; font-weight: bold;">文字色:</label>\n          <select id="${i}-text-color" class="swal2-select" style="margin: 0;">\n            <option value="white" ${"white"===n?"selected":""}>白</option>\n            <option value="black" ${"black"===n?"selected":""}>黒</option>\n          </select>\n        </div>\n      `}function T(t="widget"){return{fontSize:document.getElementById(`${t}-font-size`).value,textAlign:document.getElementById(`${t}-text-align`).value,textColor:document.getElementById(`${t}-text-color`).value}}function B(t,e,n,i){const o="center"===e?"center":"right"===e?"flex-end":"space-between",a="large"===i?"20px":"extra-large"===i?"24px":"16px";return{headerStyle:`background: ${t} !important; justify-content: ${o};`,titleStyle:`color: ${n}; font-size: ${a};`}}function M(t,e,n,i,o,a,d,r){return`data-type="${e}" data-id="${t}" data-has-header="${n}" data-custom-title="${i}" data-custom-color="${o||""}" data-font-size="${a}" data-text-align="${d}" data-text-color="${r}"`}function q(t,e=!0,n=null,i=null,o="standard",a="left",d="white"){const r=e?"":"no-header",s=n||"アプリ表示",l=i||"#4caf79",c=M(t,"app-display",e,s,i,o,a,d),{headerStyle:u,titleStyle:p}=B(l,a,d,o);return`\n        <div class="portal-widget ${r}" ${c}>\n          <div class="widget-header" style="${u}">\n            <span class="widget-title" style="${p}">${s}</span>\n            <button class="widget-edit-header" onclick="editWidgetHeader('${t}')">ヘッダー編集</button>\n          </div>\n          <div class="widget-content" id="content_${t}">\n            <button class="widget-edit-btn" onclick="editAppDisplayWidget('${t}')">設定</button>\n            <button class="widget-delete-btn" onclick="deleteWidget('${t}')"><span class="deleteText">✕</span></button>\n            <p>アプリとビュー/グラフを選択してください</p>\n          </div>\n        </div>\n      `}function P(t,e=!0,n=null,i=null,o="standard",a="left",d="white"){const r=e?"":"no-header",s=n||"リッチテキスト",l=i||"#4caf79",c=M(t,"rich-text",e,s,i,o,a,d),{headerStyle:u,titleStyle:p}=B(l,a,d,o);return`\n        <div class="portal-widget ${r}" ${c}>\n          <div class="widget-header" style="${u}">\n            <span class="widget-title" style="${p}">${s}</span>\n            <button class="widget-edit-header" onclick="editWidgetHeader('${t}')">ヘッダー編集</button>\n          </div>\n          <div class="widget-content" id="content_${t}">\n            <button class="widget-edit-btn" onclick="toggleRichTextEdit('${t}')">編集</button>\n            <button class="widget-delete-btn" onclick="deleteWidget('${t}')"><span class="deleteText">✕</span></button>\n            <div class="richtext-container" id="richtext-container_${t}">\n              <div id="richtext_${t}" class="richtext-content"></div>\n            </div>\n          </div>\n        </div>\n      `}function _(t,e=!0,n=null,i=null,o="standard",a="left",d="white"){const r=e?"":"no-header",s=n||"アプリショートカット",l=i||"#4caf79",c=M(t,"app-shortcuts",e,s,i,o,a,d),{headerStyle:u,titleStyle:p}=B(l,a,d,o);return`\n        <div class="portal-widget ${r}" ${c}>\n          <div class="widget-header" style="${u}">\n            <span class="widget-title" style="${p}">${s}</span>\n            <button class="widget-edit-header" onclick="editWidgetHeader('${t}')">ヘッダー編集</button>\n          </div>\n          <div class="widget-content" id="content_${t}">\n            <button class="widget-edit-btn" onclick="editAppShortcutsWidget('${t}')">設定</button>\n            <button class="widget-delete-btn" onclick="deleteWidget('${t}')"><span class="deleteText">✕</span></button>\n            <p>ショートカットを設定してください</p>\n          </div>\n        </div>\n      `}function L(t,e=!0,n=null,i=null,o="standard",a="left",d="white"){const r=e?"":"no-header",s=n||"外部サイト",l=i||"#4caf79",c=M(t,"iframe",e,s,i,o,a,d),{headerStyle:u,titleStyle:p}=B(l,a,d,o);return`\n        <div class="portal-widget ${r}" ${c}>\n          <div class="widget-header" style="${u}">\n            <span class="widget-title" style="${p}">${s}</span>\n            <button class="widget-edit-header" onclick="editWidgetHeader('${t}')">ヘッダー編集</button>\n          </div>\n          <div class="widget-content" id="content_${t}">\n            <button class="widget-edit-btn" onclick="editIframeWidget('${t}')">設定</button>\n            <button class="widget-delete-btn" onclick="deleteWidget('${t}')"><span class="deleteText">✕</span></button>\n            <p>URLを設定してください</p>\n          </div>\n        </div>\n      `}function G(t){window.activeTabId&&window.grid&&window.activeTabId!==t&&D(),window.activeTabId=t,document.querySelectorAll(".portal-tab").forEach(t=>{t.classList.remove("active")});const e=document.querySelector(`.portal-tab[data-tab-id="${t}"]`);e&&e.classList.add("active"),N(t)}function D(){const t=window.tabs.find(t=>t.id===window.activeTabId);if(!t)return;const e=window.grid.save(),n=document.querySelectorAll(".portal-widget"),i={};n.forEach(t=>{const e=t.dataset.id;if(!e)return;const n={type:t.dataset.type,hasHeader:t.dataset.hasHeader,customTitle:t.dataset.customTitle,customColor:t.dataset.customColor,fontSize:t.dataset.fontSize,textAlign:t.dataset.textAlign,textColor:t.dataset.textColor};switch(t.dataset.type){case"app-display":n.appId=t.getAttribute("data-app-id"),n.viewId=t.getAttribute("data-view-id"),n.spaceId=t.getAttribute("data-space-id"),n.isGuestSpace=t.getAttribute("data-is-guest-space"),n.threadId=t.getAttribute("data-thread-id");break;case"rich-text":const i=t.querySelector("#richtext_"+e);i&&(n.content=i.innerHTML);break;case"app-shortcuts":const o=t.getAttribute("data-shortcuts");o&&(n.shortcuts=JSON.parse(o));break;case"iframe":const a=t.querySelector("iframe");a&&(n.url=a.src)}i[e]=n}),t.layouts=e,t.widgets=i}function N(t){const e=window.tabs.find(e=>e.id===t);e&&window.grid&&(window.grid.removeAll(),e.layouts&&Array.isArray(e.layouts)&&e.layouts.length>0&&(window.grid.load(e.layouts),e.widgets&&Object.keys(e.widgets).length>0&&setTimeout(async()=>{await O(e.widgets)},500)))}async function O(t){for(const e in t){const n=t[e],i=document.querySelector(`[data-id="${e}"]`);if(i)try{switch(n.type){case"app-display":n.appId&&n.viewId&&(i.setAttribute("data-app-id",n.appId),i.setAttribute("data-view-id",n.viewId),void 0!==n.spaceId&&i.setAttribute("data-space-id",n.spaceId||""),void 0!==n.isGuestSpace&&i.setAttribute("data-is-guest-space",n.isGuestSpace||"false"),void 0!==n.threadId&&i.setAttribute("data-thread-id",n.threadId||""),void 0===n.spaceId||void 0===n.isGuestSpace||ut[n.appId]||(ut[n.appId]={spaceId:n.spaceId||null,threadId:n.threadId||null,isGuestSpace:"true"===n.isGuestSpace||!0===n.isGuestSpace}),it(e,n.appId,n.viewId));break;case"app-shortcuts":n.shortcuts&&(n.shortcuts.forEach(t=>{void 0===t.spaceId||void 0===t.isGuestSpace||ut[t.appId]||(ut[t.appId]={spaceId:t.spaceId||null,threadId:t.threadId||null,isGuestSpace:!0===t.isGuestSpace||"true"===t.isGuestSpace,name:t.name})}),i.setAttribute("data-shortcuts",JSON.stringify(n.shortcuts)),await J(e,n.shortcuts));break;case"rich-text":if(n.content){const t=i.querySelector("#richtext_"+e);t&&(t.innerHTML=n.content)}break;case"iframe":n.url&&z(e,`\n                  <iframe src="${n.url}"\n                          width="100%"\n                          height="100%"\n                          frameborder="0"\n                          style="min-height: 200px;">\n                  </iframe>\n                `)}if(n.customTitle){const t=i.querySelector(".widget-title");t&&(t.textContent=n.customTitle),i.setAttribute("data-custom-title",n.customTitle)}else if(n.title){const t=i.querySelector(".widget-title");t&&(t.textContent=n.title)}if(n.customColor){const t=i.querySelector(".widget-header");t&&(t.style.background=n.customColor),i.setAttribute("data-custom-color",n.customColor)}const t=i.querySelector(".widget-header"),o=i.querySelector(".widget-title");if(n.fontSize&&(i.setAttribute("data-font-size",n.fontSize),o)){let t;switch(n.fontSize){case"large":t="20px";break;case"extra-large":t="24px";break;default:t="16px"}o.style.fontSize=t}n.textAlign&&t&&(i.setAttribute("data-text-align",n.textAlign),"center"===n.textAlign?t.style.justifyContent="center":"right"===n.textAlign?t.style.justifyContent="flex-end":t.style.justifyContent="space-between"),n.textColor&&o&&(i.setAttribute("data-text-color",n.textColor),o.style.color=n.textColor)}catch(t){console.error(`ウィジェット${e}の復元エラー:`,t)}}}function z(t,e){const n=document.getElementById(`content_${t}`);if(!n)return;const i=n.querySelector(".widget-edit-btn"),o=n.querySelector(".widget-delete-btn");n.innerHTML=e,i&&n.insertBefore(i,n.firstChild),o&&n.insertBefore(o,n.firstChild)}async function H(t){try{const e=kintone.getLoginUser();if(!t)return console.warn("configAppIdが設定されていません"),{canEditShared:!0,canAccessMy:!0,canAccessShared:!0};let n=!1,i=[];try{const o='判定 = "共有ポータル編集者"',d=await kintone.api(a("/records",t),"GET",{app:t,query:o});if(d.records.length>0){const t=d.records[0],o=t["データ"].value;if(o){const t=JSON.parse(o);!t.adminOnly&&t.sharedEditors?(i=t.sharedEditors,n=i.some(t=>"user"===t.type&&(t.value===e.code||t.value===e.email))):t.adminOnly&&(n=e.isAdmin||!1)}}}catch(t){console.warn("共有ポータル編集者設定取得エラー:",t),n=!0}let o=!0,d=!0;try{const n='判定 = "ポータル表示設定"',i=await kintone.api(a("/records",t),"GET",{app:t,query:n});if(i.records.length>0){const t=i.records[0],n=t["データ"].value;if(n){const t=JSON.parse(n);if(t.users&&t.users[e.code]){const n=t.users[e.code];o=!n.includes("my"),d=!n.includes("shared"),o||d||(o=!1,d=!1)}else if(t.users&&t.users[e.email]){const n=t.users[e.email];o=!n.includes("my"),d=!n.includes("shared"),o||d||(o=!1,d=!1)}else o=!0,d=!0}}}catch(t){console.warn("ポータル表示設定取得エラー:",t),o=!0,d=!0}return{canEditShared:n,canAccessMy:o,canAccessShared:d}}catch(t){return console.error("権限チェックエラー:",t),{canEditShared:!0,canAccessMy:!0,canAccessShared:!0}}}async function j(){try{const t=location.pathname,i=location.hash,o=/\/k\/\d+\//.test(t);if(o)return;const a=t.includes("/k/")&&("#/portal"===i||""===i&&"/k/"===t||i.includes("#/space/"));if(!a)return;const r=e(),s=n()?r:null,l=await d(s);if(!l)return Swal.fire({icon:"warning",title:"ポータルカスタマイズ設定用アプリが見つかりません",text:"初めにポータルカスタマイズ設定用アプリを作成してください",timer:1500,timerProgressBar:!0,showConfirmButton:!1}),void console.log("ポータルカスタマイズ設定用アプリが見つかりません。初めにポータルカスタマイズ設定用アプリを作成してください。");const c=await H(l);if(!c.canAccessMy&&!c.canAccessShared)return;window.DYNAMIC_CONFIG_APP_ID=l,window.CURRENT_SPACE_ID=r,await Promise.all([lt("https://cdn.jsdelivr.net/npm/gridstack@10.1.0/dist/gridstack-all.js"),lt("https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"),lt("https://cdn.jsdelivr.net/npm/sweetalert2@11"),lt("https://unpkg.com/quill@1.3.6/dist/quill.js"),lt("https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js")]),ct("https://cdn.jsdelivr.net/npm/gridstack@10.1.0/dist/gridstack.min.css"),ct("https://unpkg.com/quill@1.3.6/dist/quill.snow.css"),ct("https://nohohonki.github.io/portal-customization-plugin/portal-live-editor.min.css"),setTimeout(()=>{W()},500)}catch(t){console.error("ライブラリの読み込みに失敗しました:",t)}}function W(){const t=kintone.getLoginUser(),e=!st.ADMIN_ONLY||t.isAdmin;let n=document.querySelector(".kintone-portal-content-space");if(n||(n=document.querySelector(".gaia-argoui-space-spacelayout-content-space")),!n)return void console.log("ポータル画面が見つかりません（メイン領域・ゲストスペースともに検索済み）");const i=document.createElement("div");i.innerHTML=`\n        <div id="portal-customizer">\n          <div id="portal-toolbar">\n            <div id="tabs-container">\n              <div id="tabs-list">\n                <!-- タブがここに動的に追加されます -->\n              </div>\n              <button id="addTab" class="kintoneplugin-button-normal">\n                + タブ追加\n              </button>\n            </div>\n            <div class="editButtonWrap">\n              <button id="portalToggle" class="kintoneplugin-button-normal" style="display: none;">\n                マイポータル\n              </button>\n              <button id="editToggle" class="kintoneplugin-button-normal" style="display: ${e?"inline-block":"none"};">\n                編集する\n              </button>\n              <button id="editCancel" class="kintoneplugin-button-dialog-cancel">\n                キャンセル\n              </button>\n              <button id="addWidget" class="kintoneplugin-button-normal">\n                ウィジェット追加\n              </button>\n              <button id="resetLayout" class="kintoneplugin-button-dialog-cancel">\n                現在のタブをリセット\n              </button>\n              <button id="deleteMyPortal" class="kintoneplugin-button-dialog-cancel">\n                設定を初期化\n              </button>\n            </div>\n          </div>\n          <div class="grid-stack" id="portal-grid"></div>\n        </div>\n      `,n.insertBefore(i,n.firstChild),l(),h().then(async()=>{await y()})}async function U(){const t="my"===window.currentEditMode?"my":"shared",e="my"===t?"マイポータル":"共有ポータル",o=await Swal.fire({title:`${e}を削除しますか？`,text:`${e}のレイアウトとウィジェットが完全に削除され、元に戻すことはできません。`,icon:"warning",showCancelButton:!0,confirmButtonText:"はい",cancelButtonText:"いいえ"});if(o.isConfirmed)try{const o=window.DYNAMIC_CONFIG_APP_ID,d="my"===t?kintone.getLoginUser().id:0;let r;if(n()){const t=`ユーザーID = ${d}`;r=await kintone.api(a("/records",o),"GET",{app:o,query:t})}else{const t=i(),e=`ユーザーID = ${d} and 判定 = "${t}"`;r=await kintone.api(a("/records",o),"GET",{app:o,query:e})}if(r.records.length>0){const t=r.records[0].レコード番号.value;await kintone.api(a("/records",o),"DELETE",{app:o,ids:[t]})}window.grid.removeAll(!1),b(),window.editMode=!1,m(),Swal.fire({icon:"success",title:"削除完了",text:`${e}が削除されました。`,timer:2e3,timerProgressBar:!0,showConfirmButton:!1}),location.reload()}catch(t){console.error("削除エラー:",t),Swal.fire({icon:"error",title:"削除エラー",text:`${e}の削除に失敗しました。`})}}async function R(t){
const e=document.querySelector(`[data-id="${t}"]`);if(!e)return;const n=e.getAttribute("data-custom-title")||e.querySelector(".widget-title").textContent,i=e.getAttribute("data-custom-color")||"#4caf79",o=e.getAttribute("data-font-size")||"standard",a=e.getAttribute("data-text-align")||"left",d=e.getAttribute("data-text-color")||"white",r=Z(i).replace('id="widget-color"','id="edit-widget-color"').replace('for="widget-color"','for="edit-widget-color"').replace('id="hex-input"','id="edit-hex-input"').replace('for="hex-input"','for="edit-hex-input"'),{value:s}=await Swal.fire({title:"ヘッダー編集",html:`\n          <div id="headerEditSwal">\n            <div style="text-align: left; margin-bottom: 15px;">\n              <label for="edit-widget-title" style="display: block; margin-bottom: 5px; font-weight: bold;">タイトル:</label>\n              <input id="edit-widget-title" type="text" class="swal2-input" value="${n}" style="margin: 0;">\n            </div>\n\n            ${A(o,a,d,"edit")}\n\n            ${r}\n          </div>\n        `,showCancelButton:!0,confirmButtonText:"更新",cancelButtonText:"キャンセル",didOpen:()=>{const t=document.getElementById("copy-hex");t&&(t.onclick=(()=>{const e=document.getElementById("hex-code").textContent;window.copyToClipboard(e,t)})),window.selectHistoryColor=function(t){const e=document.getElementById("edit-widget-color");e&&(e.value=t,updateEditColorPreview())},window.updateEditColorPreview=function(){const t=document.getElementById("edit-widget-color"),e=document.getElementById("hex-code"),n=document.getElementById("edit-hex-input");if(t&&e){const i=t.value;e.textContent=i.toUpperCase(),n&&n.value!==i&&(n.value=i)}};const e=document.getElementById("edit-widget-color");e&&(e.onchange=window.updateEditColorPreview),window.updateEditColorPreview()},preConfirm:()=>{const t=document.getElementById("edit-widget-title").value,e=document.getElementById("edit-widget-color").value,n=T("edit");return Q(e),{title:t.trim(),color:e,...n}}});s&&V(t,s.title,s.color,s.fontSize,s.textAlign,s.textColor)}function V(t,e,n,i,o,a){const d=document.querySelector(`[data-id="${t}"]`);if(!d)return;d.setAttribute("data-custom-title",e),d.setAttribute("data-custom-color",n),i&&d.setAttribute("data-font-size",i),o&&d.setAttribute("data-text-align",o),a&&d.setAttribute("data-text-color",a);const r=d.querySelector(".widget-title");r&&(r.textContent=e);const s=d.querySelector(".widget-header");if(s){if(s.style.background=n,i){let t;switch(i){case"large":t="20px";break;case"extra-large":t="24px";break;default:t="16px"}r&&(r.style.fontSize=t)}o&&(s.style.justifyContent="center"===o?"center":"right"===o?"flex-end":"space-between"),a&&r&&(r.style.color=a)}}async function F(t){try{const e=await nt(),n=e.map(t=>{const e=ut[t.appId],n=!!e&&e.isGuestSpace,i=e?e.threadId:null;return`<label style="display: block; margin: 5px 0;">\n            <input type="checkbox" value="${t.appId}"\n                   data-name="${t.name}"\n                   data-space-id="${t.spaceId||""}"\n                   data-is-guest-space="${n}"\n                   data-thread-id="${i||""}">\n            ${t.name} (ID: ${t.appId})\n          </label>`}).join(""),{value:i}=await Swal.fire({title:"ショートカットアプリを選択",html:`\n            <div style="max-height: 300px; overflow-y: auto; text-align: left;">\n              ${n}\n            </div>\n          `,showCancelButton:!0,preConfirm:()=>{const t=document.querySelectorAll('input[type="checkbox"]:checked');return Array.from(t).map(t=>({appId:t.value,name:t.getAttribute("data-name"),spaceId:t.getAttribute("data-space-id")||null,isGuestSpace:"true"===t.getAttribute("data-is-guest-space"),threadId:t.getAttribute("data-thread-id")||null}))}});i&&i.length>0&&await J(t,i)}catch(t){console.error("アプリ一覧取得エラー:",t)}}async function J(t,e){let n=e.map(t=>({...t,iconUrl:null}));try{const t=e.map(t=>"string"==typeof t.appId?parseInt(t.appId):t.appId),i=await kintone.app.getIcons(t);n=e.map(t=>{const e="string"==typeof t.appId?parseInt(t.appId):t.appId,n=i.find(t=>String(t.app)===String(e));return{...t,iconUrl:n.url||null}})}catch(t){console.error("アプリアイコンの取得に失敗:",t)}const i=n.map(t=>{const e=t.iconUrl?`<img src="${t.iconUrl}" alt="${t.name}" class="app-icon" />`:`<div class="app-icon-placeholder">${t.name.charAt(0)}</div>`,n=t.spaceId||(ut[t.appId]?ut[t.appId].spaceId:null),i=tt(t.appId,"","",n);return`<a href="${i}" class="app-shortcut-btn" target="_blank">\n          ${e}\n          <span class="app-name">${t.name}</span>\n        </a>`}).join("");z(t,`\n        <div class="app-shortcuts-container">\n          ${i}\n        </div>\n      `);const o=document.querySelector(`[data-id="${t}"]`);o.setAttribute("data-shortcuts",JSON.stringify(n)),window.activeTabId&&window.editMode&&D()}async function Y(t){const{value:e}=await Swal.fire({title:"外部サイトURL",input:"url",inputPlaceholder:"https://example.com",showCancelButton:!0,inputValidator:t=>t?t.startsWith("http")?void 0:"有効なURLを入力してください":"URLを入力してください"});e&&(z(t,`\n          <iframe src="${e}"\n                  width="100%"\n                  height="100%"\n                  frameborder="0"\n                  style="min-height: 200px;">\n          </iframe>\n        `),window.activeTabId&&D())}function K(){const t=localStorage.getItem("widget_color_history");return t?JSON.parse(t):[]}function Q(t){let e=K();return e=e.filter(e=>e!==t),e.unshift(t),e.length>5&&(e=e.slice(0,5)),localStorage.setItem("widget_color_history",JSON.stringify(e)),e}function X(t){return t?(t=t.replace("#",""),3===t.length&&(t=t.split("").map(t=>t+t).join("")),6===t.length&&/^[a-f0-9]{6}$/i.test(t)?"#"+t.toLowerCase():null):null}function Z(t,e){const n=K();return`\n        <div style="text-align: left;">\n          <label for="widget-color" style="display: block; margin-bottom: 5px; font-weight: bold;">背景色:</label>\n          <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">\n            <input id="widget-color" type="color" value="${t}"\n                   style="width: 60px; height: 40px; border: none; border-radius: 4px; cursor: pointer;"\n                   onchange="updateColorPreview()">\n            <div id="color-preview" style="flex: 1; padding: 8px; background: white; border: 1px solid #ddd; border-radius: 4px; font-family: monospace; font-size: 12px;">\n              <div id="hex-code">${t.toUpperCase()}</div>\n            </div>\n            <button type="button" id="copy-hex" style="padding: 6px 10px; border: 1px solid #ddd; border-radius: 4px; background: white; cursor: pointer; font-size: 11px;">\n              HTMLコピー\n            </button>\n          </div>\n          <div style="margin-bottom: 10px;">\n            <label for="hex-input" style="display: block; margin-bottom: 5px; font-weight: bold; font-size: 12px;">HTMLカラーコード入力:</label>\n            <div style="display: flex; align-items: center; gap: 8px;">\n              <input id="hex-input" type="text" value="${t}" placeholder="#4CAF79 または 4CAF79"\n                     style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-family: monospace; font-size: 12px;"\n                     oninput="validateAndApplyHexInput()"\n                     onpaste="setTimeout(validateAndApplyHexInput, 10)">\n              <button type="button" id="apply-hex" onclick="applyHexInput()"\n                      style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; background: #7066E0; color: white; cursor: pointer; font-size: 11px;">\n                適用\n              </button>\n            </div>\n            <div id="hex-input-error" style="color: #d32f2f; font-size: 11px; margin-top: 4px; display: none;"></div>\n          </div>\n          ${n.length>0?`\n            <div style="margin-bottom: 10px;">\n              <label style="display: block; margin-bottom: 5px; font-weight: bold; font-size: 12px;">最近使用した色:</label>\n              <div style="display: flex; gap: 5px; flex-wrap: wrap;">\n                ${n.map(t=>`\n                  <div class="color-history-item"\n                       data-color="${t}"\n                       style="width: 24px; height: 24px; background: ${t}; border: 2px solid #ddd; border-radius: 4px; cursor: pointer; transition: all 0.2s;"\n                       onclick="selectHistoryColor('${t}')"\n                       title="${t}">\n                  </div>\n                `).join("")}\n              </div>\n            </div>\n          `:""}\n        </div>\n      `}function tt(t,e="",n="",i=null){const o=ut[t],a=!!o&&o.isGuestSpace,d=i||(o?o.spaceId:null);if(a&&d){const i=e?`/k/guest/${d}/${t}/${e}${n}`:`/k/guest/${d}/${t}${n}`;return i}{const i=e?`/k/${t}/${e}${n}`:`/k/${t}${n}`;return i}}function et(t,e=null){const n=e&&ut[e]?ut[e].spaceId:null;return n?`/k/guest/${n}/v1${t}`:kintone.api.url(`/k/v1${t}`,!0)}async function nt(){try{const t=e();let i;if(n())i=await kintone.api(`/k/guest/${t}/v1/apps`,"GET",{});else if(t)try{const e=await kintone.api("/k/v1/space.json","GET",{id:t,includeApps:!0});i={apps:e.attachedApps}}catch(t){console.error("Space APIでのアプリ一覧取得エラー:",t),i={apps:[]}}else{i=await kintone.api(kintone.api.url("/k/v1/apps",!0),"GET",{});const t={main:[],regular:[],guest:[]};i.apps.forEach(e=>{e.spaceId?/^\d+$/.test(e.spaceId)?t.regular.push(e):t.guest.push(e):t.main.push(e)});const e=o();e.isGuestSpace||(i.apps=i.apps.filter(t=>!t.spaceId))}return i.apps.forEach(t=>{t.spaceId;const e=!1;ut[t.appId]={name:t.name,spaceId:t.spaceId||null,threadId:t.threadId||null,isGuestSpace:e}}),i.apps}catch(t){return console.error("アプリ一覧取得エラー:",t),[]}}function it(t,e,n,i=!1){const o=ut[e],a=o?o.spaceId:window.CURRENT_SPACE_ID,d=!!o&&o.isGuestSpace,r=o?o.threadId:null;let s;s=i?tt(e,"report",`?report=${n}`,a):tt(e,"",n?`?view=${n}`:"",a);const l=`\n        <iframe src="${s}"\n                width="100%"\n                height="100%"\n                frameborder="0"\n                style="min-height: 300px;">\n        </iframe>\n      `;z(t,l);const c=document.querySelector(`[data-id="${t}"]`);c.setAttribute("data-app-id",e),c.setAttribute("data-view-id",n),c.setAttribute("data-is-report",i.toString()),c.setAttribute("data-space-id",a||""),c.setAttribute("data-is-guest-space",d.toString()),c.setAttribute("data-thread-id",r||""),window.activeTabId&&window.editMode&&D()}function z(t,e){const n=document.querySelector(`[data-id="${t}"]`);if(!n)return;const i=n.querySelector(".widget-content");if(!i)return;const o=i.querySelector(".widget-edit-btn"),a=i.querySelector(".widget-delete-btn");i.innerHTML=e,o&&i.insertBefore(o,i.firstChild),a&&i.insertBefore(a,i.firstChild)}async function ot(t,e){try{const n=await nt(),i={};n.forEach(t=>{i[t.appId]=`${t.name} (ID: ${t.appId})`});const{value:o}=await Swal.fire({title:"アプリを選択",input:"select",inputOptions:i,inputPlaceholder:"アプリを選択してください",showCancelButton:!0});o&&("app-view"===e?await showViewSelectionDialog(t,o):"app-display"===e&&await at(t,o))}catch(t){console.error("アプリ一覧取得エラー:",t)}}async function at(t,e){try{const[n,i]=await Promise.allSettled([kintone.api(et("/app/views",e),"GET",{app:e}),kintone.api(et("/app/reports",e),"GET",{app:e})]),o={all:"[ビュー] すべて"};if("fulfilled"===n.status){const t=n.value.views;Object.keys(t).forEach(e=>{const n=t[e];let i="[ビュー]";"CHART"===n.type?i="[グラフ]":"PIVOT"===n.type&&(i="[クロス集計表]"),o[e]=`${i} ${n.name}`})}if("fulfilled"===i.status){const t=i.value.reports;Object.keys(t).forEach(e=>{const n=t[e];o[`report_${e}`]=`[レポート] ${n.name}`})}const{value:a}=await Swal.fire({title:"ビュー・グラフを選択",input:"select",inputOptions:o,inputPlaceholder:"ビューまたはグラフを選択してください",showCancelButton:!0});if(a){let o,d=!1;if(a.startsWith("report_")){const t=a.replace("report_",""),e=i.value.reports[t];o=e.id,d=!0}else if("all"===a)o=null;else{const t=n.value.views[a];o=t.id}it(t,e,o,d)}}catch(t){console.error("ビュー・レポート一覧取得エラー:",t)}}function dt(t){const e=document.getElementById(`richtext-container_${t}`),n=document.getElementById(`richtext_${t}`),i=document.querySelector(`[data-id="${t}"] .widget-edit-btn`);if(!e||!n||!i)return;const o=document.getElementById(`editor_${t}`);o&&o.remove();const a=e.querySelectorAll(".ql-toolbar");a.forEach(t=>t.remove());const d=n.innerHTML;e.classList.add("editing"),i.textContent="保存",n.style.display="none";const r=document.createElement("div");r.id=`editor_${t}`,e.appendChild(r),window.quillInstances||(window.quillInstances={});const s=[["bold","italic","underline","strike"],["blockquote","code-block"],[{header:1},{header:2}],[{list:"ordered"},{list:"bullet"}],[{script:"sub"},{script:"super"}],[{indent:"-1"},{indent:"+1"}],[{direction:"rtl"}],[{size:["small",!1,"large","huge"]}],[{header:[1,2,3,4,5,6,!1]}],[{color:[]},{background:[]}],[{align:[]}],["clean"],["link","image"]],l=new Quill(`#editor_${t}`,{theme:"snow",modules:{toolbar:s},placeholder:"テキストを入力してください..."});l.root.innerHTML=d,window.quillInstances[t]=l,setTimeout(()=>{l&&l.focus&&l.focus()},100)}function rt(t){const e=document.getElementById(`richtext-container_${t}`),n=document.getElementById(`richtext_${t}`),i=document.querySelector(`[data-id="${t}"] .widget-edit-btn`),o=document.getElementById(`editor_${t}`);if(!e||!n||!i)return;if(window.quillInstances&&window.quillInstances[t]){const e=window.quillInstances[t],i=e.root.innerHTML;n.innerHTML=i,delete window.quillInstances[t]}o&&o.remove();const a=e.querySelectorAll(".ql-toolbar");a.forEach(t=>t.remove()),e.classList.remove("editing"),i.textContent="編集",n.style.display="block",window.activeTabId&&window.editMode&&D()}const st=t||{CONFIG_APP_ID:null};window.PORTAL_CONFIG=st;const lt=t=>new Promise((e,n)=>{const i=document.createElement("script");i.src=t,i.onload=e,i.onerror=n,document.head.appendChild(i)}),ct=t=>{const e=document.createElement("link");e.rel="stylesheet",e.href=t,document.head.appendChild(e)};window.generateGridCSS=function(t){const e=100/t,n=`\n        .grid-stack.gs-${t} > .grid-stack-item {\n          width: ${e}%;\n        }\n        `+Array.from({length:t-1},(n,i)=>{const o=i+1;return`\n          .grid-stack.gs-${t} > .grid-stack-item[gs-x='${o}'] { left: ${e*o}%; }\n          .grid-stack.gs-${t} > .grid-stack-item[gs-w='${o+1}'] { width: ${e*(o+1)}%; }\n          `}).join(""),i=document.createElement("style");i.textContent=n,document.head.appendChild(i)},window.deleteWidget=function(t){window.editMode&&Swal.fire({title:"ウィジェットを削除しますか？",text:"ウィジェットが削除され、元には戻せなくなります。",icon:"warning",showCancelButton:!0,confirmButtonText:"はい",cancelButtonText:"いいえ"}).then(e=>{if(e.isConfirmed){const e=document.querySelector(`[gs-id="${t}"]`);e&&window.grid.removeWidget(e)}})},window.editWidgetHeader=function(t){window.editMode&&R(t)},window.editAppDisplayWidget=function(t){ot(t,"app-display")},window.toggleRichTextEdit=function(t){if(!window.editMode)return;const e=document.getElementById(`richtext-container_${t}`),n=document.getElementById(`richtext_${t}`),i=document.querySelector(`[data-id="${t}"] .widget-edit-btn`);if(!e||!n||!i)return;const o=e.classList.contains("editing");o?rt(t):dt(t)},window.editAppShortcutsWidget=async function(t){await F(t)},window.editIframeWidget=function(t){Y(t)},window.updateColorPreview=function(){const t=document.getElementById("widget-color"),e=document.getElementById("hex-code"),n=document.getElementById("hex-input");if(t&&e){const i=t.value;e.textContent=i.toUpperCase(),n&&n.value!==i&&(n.value=i)}},window.selectHistoryColor=function(t){const e=document.getElementById("widget-color");e&&(e.value=t,window.updateColorPreview())},window.copyToClipboard=function(t,e){navigator.clipboard.writeText(t).then(()=>{const t=e.textContent;e.textContent="コピー済み!",e.style.background="#505351",e.style.color="white",setTimeout(()=>{e.textContent=t,e.style.background="white",e.style.color="black"},1e3)}).catch(()=>{const n=document.createElement("textarea");n.value=t,document.body.appendChild(n),n.select(),document.execCommand("copy"),document.body.removeChild(n);const i=e.textContent;e.textContent="コピー済み!",e.style.background="#505351",e.style.color="white",setTimeout(()=>{e.textContent=i,e.style.background="white",e.style.color="black"},1e3)})},window.validateAndApplyHexInput=function(){const t=document.getElementById("hex-input"),e=document.getElementById("hex-input-error"),n=document.getElementById("apply-hex");if(!t||!e||!n)return;const i=t.value.trim();if(!i)return e.style.display="none",void(n.disabled=!1);const o=X(i);o?(e.style.display="none",n.disabled=!1,t.style.borderColor="#ddd",applyHexInput()):(e.textContent="無効なカラーコードです（例: #4CAF79, 4CAF79, #fff）",e.style.display="block",n.disabled=!0,t.style.borderColor="#d32f2f")},window.applyHexInput=function(){const t=document.getElementById("hex-input")||document.getElementById("edit-hex-input"),e=document.getElementById("widget-color")||document.getElementById("edit-widget-color");if(!t||!e)return;const n=t.value.trim(),i=X(n);i&&(e.value=i,t.value=i,document.getElementById("widget-color")&&window.updateColorPreview&&window.updateColorPreview(),document.getElementById("edit-widget-color")&&window.updateEditColorPreview&&window.updateEditColorPreview())};let ut={};j()},"function"==typeof window.initPortalCustomizer||"undefined"!=typeof kintone&&kintone.events.on(["portal.show","space.portal.show"],async()=>{await window.initPortalCustomizer()})})();